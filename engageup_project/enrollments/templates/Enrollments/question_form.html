{% extends 'base.html' %}
{% load static %}

{% block content %}
<h2>{% if is_edit %}問題を編集{% else %}問題を追加{% endif %}</h2>

<a href="{% url 'enrollments:question_list' exam_id %}">
    ← 問題一覧に戻る
</a>

<hr>

<form method="post">
    {% csrf_token %}

    {{ form.as_p }}

    <h3>選択肢</h3>

    {% if formset.non_form_errors %}
    <div style="color: red; font-weight: bold; margin-bottom: 10px;">
        {{ formset.non_form_errors }}
    </div>
    {% endif %}

    {{ formset.management_form }}

    <div id="choices">
        {% for choice_form in formset %}
            <div class="choice-form">
                {{ choice_form.id }}

                <div>
                    <label>選択肢</label>
                    {{ choice_form.text }}
                </div>

                <div>
                    <label>正解</label>
                    {{ choice_form.is_correct }}
                </div>

                {# DELETEはhiddenで保持（文字も出さない） #}
                {{ choice_form.DELETE.as_hidden }}

                <button type="button" class="remove-choice">削除</button>
                <hr>
            </div>
        {% endfor %}
    </div>

    <button type="button" id="add-choice">＋選択肢を追加</button>

    <br><br>
    <button type="submit">
        {% if is_edit %}更新{% else %}登録{% endif %}
    </button>
</form>

<!-- ===== formset用 JS（完全版） ===== -->
<script>
document.addEventListener("DOMContentLoaded", function () {

    const choicesDiv = document.getElementById("choices");
    const addButton = document.getElementById("add-choice");
    const totalForms = document.querySelector('input[name$="-TOTAL_FORMS"]');

    addButton.addEventListener("click", function () {
        const index = totalForms.value;

        const html = `
        <div class="choice-form">
            <input type="hidden" name="choice_set-${index}-id" id="id_choice_set-${index}-id">

            <div>
                <label>選択肢</label>
                <input type="text"
                       name="choice_set-${index}-text"
                       id="id_choice_set-${index}-text">
            </div>

            <div>
                <label>正解</label>
                <input type="checkbox"
                       name="choice_set-${index}-is_correct"
                       id="id_choice_set-${index}-is_correct">
            </div>

            <input type="hidden"
                   name="choice_set-${index}-DELETE"
                   id="id_choice_set-${index}-DELETE">

            <button type="button" class="remove-choice">削除</button>
            <hr>
        </div>
        `;

        choicesDiv.insertAdjacentHTML("beforeend", html);
        totalForms.value = parseInt(index) + 1;
    });

    choicesDiv.addEventListener("click", function (e) {
        if (e.target.classList.contains("remove-choice")) {
            const formDiv = e.target.closest(".choice-form");
            const deleteInput = formDiv.querySelector(
                'input[name$="-DELETE"]'
            );
            if (deleteInput) {
                deleteInput.value = "on";
            }
            formDiv.style.display = "none";
        }
    });
});
</script>

{% endblock %}
