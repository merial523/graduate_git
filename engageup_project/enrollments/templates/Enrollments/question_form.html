{% extends base_template %}

{% load static %}

{% block content %}
<h2>{% if is_edit %}問題を編集{% else %}問題を追加{% endif %}</h2>

<!-- ★ ここにAI生成へのリンクボタンを追加 -->
<div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
    <a href="{% url 'enrollments:question_list' exam_id %}" style="text-decoration: none; color: #666;">
        ← 問題一覧に戻る
    </a>

    {% if not is_edit %}
        <span style="color: #ccc;">|</span>
        <a href="{% url 'enrollments:exam_ai_add' exam_id %}" 
           style="background-color: #4CAF50; color: white; padding: 8px 15px; text-decoration: none; border-radius: 5px; font-weight: bold; font-size: 0.9em;">
            ✨ AIで問題を自動生成する
        </a>
    {% endif %}
</div>



<hr>

<form method="post">
    {% csrf_token %}

    {{ form.as_p }}

    <h3>選択肢</h3>

    {% if formset.non_form_errors %}
    <div style="color: red; font-weight: bold; margin-bottom: 10px;">
        {{ formset.non_form_errors }}
    </div>
    {% endif %}

    {{ formset.management_form }}

    <div id="choices">
        {% for choice_form in formset %}
            <div class="choice-form">
                {{ choice_form.id }}

                <div>
                    <label>選択肢</label>
                    {{ choice_form.text }}
                </div>

                <div>
                    <label>正解</label>
                    {{ choice_form.is_correct }}
                </div>

                {# DELETEはhiddenで保持（文字も出さない） #}
                {{ choice_form.DELETE.as_hidden }}

                <button type="button" class="remove-choice">削除</button>
                <hr>
            </div>
        {% endfor %}
    </div>

    <button type="button" id="add-choice">＋選択肢を追加</button>

    <br><br>
    <button type="submit">
        {% if is_edit %}更新{% else %}登録{% endif %}
    </button>
    <a href="{% url 'enrollments:question_list' exam_id %}" style="text-decoration: none; color: #666;">
        ← 問題一覧に戻る
    </a>
</form>

<!-- ===== formset用 JS（完全版） ===== -->
<script>
document.addEventListener("DOMContentLoaded", function () {

    const choicesDiv = document.getElementById("choices");
    const addButton = document.getElementById("add-choice");
    const totalForms = document.querySelector('input[name$="-TOTAL_FORMS"]');
    const prefix = totalForms.name.replace("-TOTAL_FORMS", "");

    addButton.addEventListener("click", function () {
        const index = parseInt(totalForms.value);

        const html = `
        <div class="choice-form">
            <input type="hidden" name="${prefix}-${index}-id" id="${prefix}-${index}-id">

            <div>
                <label>選択肢</label>
                <input type="text"
                       name="${prefix}-${index}-text"
                       id="id_${prefix}-${index}-text">
            </div>

            <div>
                <label>正解</label>
                <input type="checkbox"
                       name="${prefix}-${index}-is_correct"
                       id="id_${prefix}-${index}-is_correct">
            </div>

            <input type="hidden"
                   name="${prefix}-${index}-DELETE"
                   id="id_${prefix}-${index}-DELETE">

            <button type="button" class="remove-choice">削除</button>
            <hr>
        </div>
        `;

        choicesDiv.insertAdjacentHTML("beforeend", html);
        totalForms.value = parseInt(index) + 1;
    });

    choicesDiv.addEventListener("click", function (e) {
        if (e.target.classList.contains("remove-choice")) {
            const formDiv = e.target.closest(".choice-form");
            const deleteInput = formDiv.querySelector(
                'input[name$="-DELETE"]'
            );
            if (deleteInput) {
                deleteInput.value = "on";
            }
            formDiv.style.display = "none";
        }
    });
});
</script>

{% endblock %}
