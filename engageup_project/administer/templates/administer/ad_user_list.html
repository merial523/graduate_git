{% extends base_template %}

{% load static %}
{% block breadcrumb %}<li class="breadcrumb-item active">ユーザー管理</li>{% endblock %}

{% block content %}
<div class="user-management-container pb-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
      <h1 class="page-title text-dark m-0 fw-bold">ユーザー管理</h1>
    </div>

    {% if request.user.rank == 'administer' %}
    <div class="display-toggle">
      {% if show_all %}
      <a href="{% url 'administer:user_list' %}" class="btn btn-outline-secondary btn-sm rounded-pill px-3">
        <span class="material-icons fw-bold small align-middle">visibility</span>有効ユーザーのみ
      </a>
      {% else %}
      <a href="{% url 'administer:user_list' %}?show=all" class="btn btn-outline-dark btn-sm rounded-pill px-3">
        <span class="material-icons fw-bold small align-middle">visibility_off</span> 全ユーザー表示
      </a>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <!-- 検索 -->
  <div class="row g-3 mb-4 align-items-center">
    <div class="col-xl-4 col-lg-5">
      <form method="get" action="{% url 'administer:user_list' %}" class="d-flex gap-2">
        <div class="search-input-group shadow-sm flex-grow-1">
          <span class="material-icons text-muted">search</span>
          <input type="text" name="q" placeholder="名前やメールで検索..." value="{{ request.GET.q }}" />
        </div>
        {% if show_all %}<input type="hidden" name="show" value="all" />{% endif %}
      </form>
    </div>

    <div class="col-xl-8 col-lg-7 text-end">
      <div class="d-flex gap-2 justify-content-end align-items-center flex-nowrap">
        <a href="{% url 'moderator:moderator_create_user'%}" class="btn btn-primary shadow-sm rounded-pill px-4 fw-bold">
          <span class="material-icons">person_add</span> ユーザー作成
        </a>
        
        {% if request.user.rank == 'administer' %}
        <a href="{% url 'administer:select_rank'%}" class="btn btn-success shadow-sm text-nowrap">
          <span class="material-icons">published_with_changes</span> 権限変更
        </a>
        <!-- ヘルプボタンの追加 -->
        <a href="javascript:void(0)" class="text-muted small text-decoration-none ms-3 d-inline-flex align-items-center help-trigger" data-bs-toggle="modal" data-bs-target="#helpModal">
          <span class="material-icons size-18 me-1">help_outline</span> ヘルプ
        </a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- リストテーブル -->
  <form method="post" id="user-bulk-form">
    {% csrf_token %}
    <input type="hidden" name="action" id="bulk-action-input" value="">
    
    <div class="table-responsive admin-card border-0 shadow-sm rounded-4 overflow-hidden bg-white">
      <table class="table table-hover align-middle mb-0">
        <thead class="bg-light border-bottom">
          <tr>
            {% if request.user.rank == 'administer' %}
            <th class="text-center" style="width: 70px">選択</th>
            {% endif %}
            <th style="width: 140px">権限</th>
            <th>ユーザー名</th>
            <th>メールアドレス</th>
            <th class="text-center" style="width: 100px">状態</th>
          </tr>
        </thead>
        <tbody>
          {% for user_item in users %}
          <tr class="{% if request.user.rank == 'administer' and user_item != request.user %}user-row{% endif %} {% if not user_item.is_active %}opacity-50{% endif %}">
            {% if request.user.rank == 'administer' %}
            <td class="text-center">
              {% if user_item == request.user %}
              <span class="material-icons text-muted small" title="自分自身は操作できません">lock</span>
              {% else %}
              <input type="checkbox" name="selected_user" value="{{ user_item.pk }}" class="form-check-input row-checkbox" />
              {% endif %}
            </td>
            {% endif %}
            <td>
                <span class="badge {% if user_item.rank == 'administer' %}bg-dark{% elif user_item.rank == 'moderator' %}bg-primary{% else %}bg-secondary-subtle text-dark border{% endif %} rounded-pill px-3 fw-normal">
                    {{ user_item.get_rank_display|default:user_item.rank }}
                </span>
            </td>
            <td>
              <div class="d-flex align-items-center gap-2">
                <span class="fw-bold text-dark">{{ user_item.username }}</span>
                {% if user_item == request.user %}<span class="badge bg-light text-primary border small" style="font-size: 0.7rem">あなた</span>{% endif %}
              </div>
            </td>
            <td class="text-muted small">{{ user_item.email }}</td>
            <td class="text-center">
                {% if user_item.is_active %}
                    <span class="material-icons text-success" title="有効">check_circle</span>
                {% else %}
                    <span class="text-danger material-icons" title="削除済み">block</span>
                {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
              <td colspan="4" class="text-center py-5 text-muted">
                <div class="mb-3">
                  <span class="material-icons" style="font-size: 48px; opacity: 0.3;">search_off</span>
                </div>
                <p class="mb-1 fw-bold">該当するユーザーが見つかりません</p>
                <p class="small mb-0">条件を変えて再度お試しください</p>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if request.user.rank == 'administer' %}
    <!-- フローティング・アクションバー（アドミンのみ表示） -->
    <div class="action-bar-container" id="floating-action-bar">
        <div class="action-bar-inner shadow-lg mx-3 mb-3 rounded-pill border-0 bg-dark text-white">
            <div class="container-fluid px-4 py-2">
                <div class="row align-items-center">
                    <div class="col-md-auto">
                        <div class="selection-count py-1 d-flex align-items-center">
                            <span class="material-icons text-primary me-2">how_to_reg</span>
                            <span id="selected-count-display" class="fw-bold fs-5 me-2">0</span> 名を選択中
                        </div>
                    </div>
                    <div class="col text-end">
                        <div class="d-flex gap-2 justify-content-end">
                            {% if show_all %}
                            <button type="button" class="btn btn-warning btn-sm rounded-pill px-4 fw-bold action-trigger" 
                                    data-action="restore" data-msg="ユーザーを復元しています...">
                                <span class="material-icons align-middle size-18">settings_backup_restore</span> 一括復元
                            </button>
                            {% else %}
                            <button type="button" class="btn btn-danger btn-sm rounded-pill px-4 fw-bold action-trigger" 
                                    data-action="soft_delete" data-msg="ユーザーを削除しています...">
                                <span class="material-icons align-middle size-18">delete_outline</span> 一括削除
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
  </form>
    
  <!-- ページネーション -->
  {% if is_paginated %}
  <nav aria-label="Page navigation" class="mt-5">
    <ul class="pagination justify-content-center align-items-center gap-2">
      
      {# 前へボタン：最初のページではない時のみ表示 #}
      {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link pagination-circle shadow-sm" 
          href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if show_all %}&show=all{% endif %}{% if request.GET.rank %}&rank={{ request.GET.rank }}{% endif %}{% if request.GET.rank_filter %}&rank_filter={{ request.GET.rank_filter }}{% endif %}" aria-label="Previous">
          <span class="material-icons">chevron_left</span>
        </a>
      </li>
      {% endif %}

      {# ページ番号 #}
      {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
        <li class="page-item active" aria-current="page">
          <span class="page-link pagination-circle shadow-sm fw-bold">{{ num }}</span>
        </li>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
        <li class="page-item">
          <a class="page-link pagination-circle shadow-sm text-dark" 
            href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if show_all %}&show=all{% endif %}{% if request.GET.rank %}&rank={{ request.GET.rank }}{% endif %}{% if request.GET.rank_filter %}&rank_filter={{ request.GET.rank_filter }}{% endif %}">{{ num }}</a>
        </li>
        {% endif %}
      {% endfor %}

      {# 次へボタン：最後のページではない時のみ表示 #}
      {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link pagination-circle shadow-sm" 
          href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if show_all %}&show=all{% endif %}{% if request.GET.rank %}&rank={{ request.GET.rank }}{% endif %}{% if request.GET.rank_filter %}&rank_filter={{ request.GET.rank_filter }}{% endif %}" aria-label="Next">
          <span class="material-icons">chevron_right</span>
        </a>
      </li>
      {% endif %}

    </ul>
  </nav>

  <div class="text-center mt-3">
      <p class="pagination-info text-muted">
          {{ page_obj.start_index }} - {{ page_obj.end_index }}件目 / 全 {{ paginator.count }} 件
      </p>
  </div>
  {% endif %}
</div>

<!-- ヘルプモーダル -->
<div class="modal fade" id="helpModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-5 overflow-hidden">

      <!-- ヘッダー -->
      <div class="modal-header bg-dark text-white border-0 py-3">
        <h5 class="modal-title fw-bold d-flex align-items-center">
          <span class="material-icons me-2">help_outline</span>
          ユーザーの削除・復元方法
        </h5>
        <button type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
                aria-label="Close"></button>
      </div>

      <!-- 本文 -->
      <div class="modal-body px-4 py-3">

        <!-- 削除 -->
        <section class="mb-3">
          <h6 class="fw-bold text-danger d-flex align-items-center mb-2">
            <span class="material-icons me-2">delete_outline</span>
            ユーザーを削除する場合
          </h6>
          <ol class="small text-muted ps-3 mb-0">
            <li class="mb-1">
              リストから削除したいユーザーの行をクリック、または左側のチェックボックスを選択します。
            </li>
            <li class="mb-1">
              画面下部に黒い <b>「アクションバー」</b> が表示されます。
            </li>
            <li>
              <b>「一括削除」</b> ボタンを押すと、ユーザーはログイン不可状態（削除済み）になります。
            </li>
          </ol>
        </section>

        <hr class="my-3">

        <!-- 復元 -->
        <section>
          <h6 class="fw-bold text-warning d-flex align-items-center mb-2">
            <span class="material-icons me-2">settings_backup_restore</span>
            ユーザーを復元する場合
          </h6>
          <ol class="small text-muted ps-3 mb-0">
            <li class="mb-1">
              画面上部の <b>「全ユーザー表示」</b> ボタンを押し、削除済みのユーザーを表示させます。
            </li>
            <li class="mb-1">
              「削除済み」バッジがついたユーザーを選択します。
            </li>
            <li>
              アクションバーの <b>「一括復元」</b> ボタンを押すと、再度ログインが可能になります。
            </li>
          </ol>
        </section>

      </div>

      <!-- フッター -->
      <div class="modal-footer border-0 pt-0 px-3 pb-3">
        <button type="button"
                class="btn btn-light rounded-pill px-4 shadow-sm fw-bold w-100"
                data-bs-dismiss="modal">
          閉じる
        </button>
      </div>

    </div>
  </div>
</div>

<!-- 確認用ポップアップモーダル (デザイン維持) -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-5">
            <div class="modal-header border-0 pt-4 px-4">
                <h5 class="modal-title fw-800" id="confirmTitle">確認</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body px-4" id="confirmBody"></div>
            <div class="modal-footer border-0 pb-4 px-4">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-danger rounded-pill px-4 fw-bold" id="confirm-execute-btn">実行する</button>
            </div>
        </div>
    </div>
</div>

<!-- 処理中/完了ポップアップモーダル -->
<div class="modal fade" id="statusModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-5">
            <div class="modal-body text-center p-5">
                <div id="modal-loading">
                    <div class="custom-loader mb-4"></div>
                    <h5 class="fw-800 text-primary" id="loading-text">処理しています...</h5>
                    <p class="text-muted small mb-0">そのまま少々お待ちください</p>
                </div>
                <div id="modal-success" style="display: none;">
                    <div class="success-icon-wrapper mb-4">
                        <span class="material-icons text-success" style="font-size: 80px;">check_circle</span>
                    </div>
                    <h5 class="fw-800 text-dark">完了しました！</h5>
                    <p class="text-muted small mb-0">リストを更新しています...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
  .fw-800 { font-weight: 800; }
  .size-18 { font-size: 18px; }
  
  /* 行選択スタイル */
  .user-row { cursor: pointer; transition: background-color 0.2s; }
  .table-selected { background-color: rgba(118, 177, 157, 0.1) !important; }

  /* ヘルプボタンのスタイル */
  .help-trigger {
    transition: 0.2s;
    opacity: 0.7;
  }
  .help-trigger:hover {
    opacity: 1;
    color: var(--primary-color) !important;
  }

  /* フローティング・アクションバーのスタイル */
  .action-bar-container {
    position: fixed;
    bottom: 0;
    left: var(--sidebar-width, 260px); 
    width: calc(100% - var(--sidebar-width, 260px));
    z-index: 1000;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translateY(100px);
    opacity: 0;
    pointer-events: none;
  }
  .action-bar-container.active {
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto;
  }
  .action-bar-inner { background: #2d3436 !important; }

  /* サイドバー折りたたみ時との連動 */
  .sidebar-collapsed .action-bar-container {
    left: var(--sidebar-collapsed-width, 88px);
    width: calc(100% - var(--sidebar-collapsed-width, 88px));
  }

  .custom-loader { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; display: inline-block; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  .search-input-group { border-radius: 50px; padding: 6px 15px; display: flex; align-items: center; border: 1px solid rgba(0,0,0,0.05); }
  .search-input-group input { border: none; outline: none; background: transparent; margin-left: 8px; width: 100%; }

  @media (max-width: 991px) {
    .action-bar-container { left: 0; width: 100%; }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const rows = document.querySelectorAll('.user-row');
    const checkboxes = document.querySelectorAll('.row-checkbox');
    const bulkForm = document.getElementById('user-bulk-form');
    const actionInput = document.getElementById('bulk-action-input');
    const actionBar = document.getElementById('floating-action-bar');
    const countDisplay = document.getElementById('selected-count-display');
    
    // モーダルの初期化
    const statusModal = new bootstrap.Modal(document.getElementById('statusModal'));
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    const confirmExecuteBtn = document.getElementById('confirm-execute-btn');

    // 実行待ちの状態を保持する変数
    let pendingAction = '';
    let pendingMsg = '';

    // 選択状態とアクションバーの表示更新
    function updateSelection() {
        const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
        if (countDisplay) countDisplay.innerText = checkedCount;
        
        if (actionBar) {
            if (checkedCount > 0) {
                actionBar.classList.add('active');
            } else {
                actionBar.classList.remove('active');
            }
        }
    }

    // 行クリックで選択
    rows.forEach(row => {
        row.addEventListener('click', function(e) {
            if (e.target.type === 'checkbox' || e.target.tagName === 'A') return;
            const cb = this.querySelector('.row-checkbox');
            if (cb) {
                cb.checked = !cb.checked;
                this.classList.toggle('table-selected', cb.checked);
                updateSelection();
            }
        });
    });

    // チェックボックス直接クリック
    checkboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            this.closest('tr').classList.toggle('table-selected', this.checked);
            updateSelection();
        });
    });

    // --- ここから追加・変更部分 ---

    // アクション実行ボタン（一括削除・復元ボタン）を押した時
    document.querySelectorAll('.action-trigger').forEach(btn => {
        btn.addEventListener('click', function() {
            pendingAction = this.dataset.action;
            pendingMsg = this.dataset.msg;
            
            // 確認モーダルのテキストを設定
            if (pendingAction === 'soft_delete') {
                document.getElementById('confirmTitle').innerText = 'ユーザー削除の確認';
                document.getElementById('confirmBody').innerHTML = '<p class="mb-0">選択したユーザーを削除してもよろしいですか？</p><p class="text-muted extra-small mt-2">※削除されたユーザーはログインできなくなります。</p>';
            } else {
                document.getElementById('confirmTitle').innerText = 'ユーザー復元の確認';
                document.getElementById('confirmBody').innerHTML = '<p class="mb-0">選択したユーザーを復元してもよろしいですか？</p>';
            }
            
            // 確認画面を表示
            confirmModal.show();
        });
    });

    // 確認モーダルの中の「実行する」ボタンを押した時
    confirmExecuteBtn.addEventListener('click', function() {
        // 確認モーダルを閉じる
        confirmModal.hide();
        
        // 処理中表示の設定
        document.getElementById('loading-text').innerText = pendingMsg;
        actionInput.value = pendingAction;
        
        // ローディング画面を表示
        statusModal.show();

        // 演出用タイマー（完了アニメーション後に送信）
        setTimeout(() => {
            document.getElementById('modal-loading').style.display = 'none';
            document.getElementById('modal-success').style.display = 'block';
            setTimeout(() => { 
                bulkForm.submit(); 
            }, 800);
        }, 1200);
    });
});
</script>
{% endblock %}