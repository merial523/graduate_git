{% extends base_template %}
{% load static %}
{% block title %}権限変更 | EngageUp{% endblock %}
{% block breadcrumb %}
<li class="breadcrumb-item">
  <a href="{% url 'administer:user_list' %}">ユーザー管理</a>
</li>
<li class="breadcrumb-item active" aria-current="page">権限変更</li>
{% endblock %} {% block content %}
<div class="user-management-container pb-5">
  <div class="mb-4">
    <h1 class="page-title text-dark m-0 fw-800">権限変更</h1>
  </div>

  <!-- フィルタ ＆ 検索バー -->
  <div class="row g-3 mb-4 align-items-center">
    <div class="col-lg-7">
      <form method="get" class="d-flex gap-2">
        <div class="search-input-group shadow-sm flex-grow-1">
          <span class="material-icons text-muted">search</span>
          <input
            type="text"
            name="q"
            placeholder="名前やメールで検索..."
            value="{{ request.GET.q }}"
          />
        </div>
        <!-- 権限フィルタ -->
        <select
          name="rank_filter"
          class="form-select border-0 shadow-sm rounded-4 px-3"
          style="width: 160px; background-color: var(--card-bg)"
          onchange="this.form.submit()"
        >
          <option
            value="all"
            {%
            if
            current_rank=""
            ="all"
            %}selected{%
            endif
            %}
          >
            全ての権限
          </option>
          {% for r_choice in rank_choices %}
          <option
            value="{{ r_choice }}"
            {%
            if
            current_rank=""
            ="r_choice"
            %}selected{%
            endif
            %}
          >
            {{ r_choice }}
          </option>
          {% endfor %}
        </select>
      </form>
    </div>
  </div>

  <!-- 更新用フォーム -->
  <form method="post" id="rank-update-form">
    {% csrf_token %}

    <div class="admin-card border-0 shadow-sm mb-4 overflow-hidden">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0" id="user-table">
          <thead class="bg-light">
            <tr>
              <th class="text-center" style="width: 70px">選択</th>
              <th style="width: 140px">現在のランク</th>
              <th>ユーザー名</th>
              <th>メールアドレス</th>
            </tr>
          </thead>
          <tbody>
            {% for user_item in users %}
            <tr
              class="user-row {% if user_item == request.user %}is-self{% endif %} {% if not user_item.is_active %}is-deleted{% endif %}"
              data-user-id="{{ user_item.pk }}"
            >
              <td class="text-center">
                {% if user_item == request.user %}
                <span class="material-icons text-muted" style="font-size: 18px"
                  >lock</span
                >
                {% else %}
                <input
                  type="checkbox"
                  name="selected_user"
                  value="{{ user_item.pk }}"
                  class="form-check-input row-checkbox"
                />
                {% endif %}
              </td>
              <td><span class="user-role-badge">{{ user_item.rank }}</span></td>
              <td>
                <div class="d-flex align-items-center gap-2">
                  <span class="fw-bold text-dark"
                    >{{ user_item.username }}</span
                  >
                  {% if user_item == request.user %}
                  <span
                    class="badge bg-soft-blue text-primary small py-1 px-2 border border-primary border-opacity-10"
                    >あなた</span
                  >
                  {% endif %}
                  <!--  削除済みインジケーター -->
                  {% if not user_item.is_active %}
                  <span
                    class="badge bg-danger rounded-pill"
                    style="font-size: 0.65rem"
                    >削除済み</span
                  >
                  {% endif %}
                </div>
              </td>
              <td class="text-muted small">{{ user_item.email }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    {% if is_paginated %}
    <nav class="mb-5">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item">
          <a
            class="page-link shadow-sm rounded-circle mx-1"
            href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if current_rank != 'all' %}&rank_filter={{ current_rank }}{% endif %}"
            ><span class="material-icons">chevron_left</span></a
          >
        </li>
        {% endif %}
        <li class="page-item active">
          <span class="page-link shadow-sm rounded-circle mx-1"
            >{{ page_obj.number }}</span
          >
        </li>
        {% if page_obj.has_next %}
        <li class="page-item">
          <a
            class="page-link shadow-sm rounded-circle mx-1"
            href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if current_rank != 'all' %}&rank_filter={{ current_rank }}{% endif %}"
            ><span class="material-icons">chevron_right</span></a
          >
        </li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}

    <!-- ボトム・アクション・バー（透過なし） -->
    <div class="action-bar-container">
      <div class="action-bar-inner shadow-lg">
        <div class="container">
          <div class="row align-items-center">
            <div class="col-md-auto d-none d-lg-block">
              <div class="selection-count">
                <span class="material-icons text-primary">how_to_reg</span>
                <span id="selected-count-display">0</span> 名を選択中
              </div>
            </div>
            <div class="col-md">
              <div class="custom-radio-group">
                <ul
                  class="d-flex justify-content-center justify-content-md-start"
                >
                  {% for radio in form.rank %}
                  <li>
                    <label>
                      {{ radio.tag }}
                      <span class="choice-label">{{ radio.choice_label }}</span>
                    </label>
                  </li>
                  {% endfor %}
                </ul>
              </div>
            </div>
            <div class="col-md-auto">
              <button
                type="button"
                id="submit-trigger"
                class="btn btn-success btn-lg shadow-sm fw-800 px-5"
              >
                権限を更新する
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- 処理中/完了ポップアップモーダル -->
<div
  class="modal fade"
  id="statusModal"
  tabindex="-1"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-5">
      <div class="modal-body text-center p-5">
        <div id="modal-loading">
          <div class="custom-loader mb-4"></div>
          <h5 class="fw-800 text-primary">権限を更新しています...</h5>
          <p class="text-muted small mb-0">そのまま少々お待ちください</p>
        </div>
        <div id="modal-success" style="display: none">
          <div class="success-icon-wrapper mb-4">
            <span class="material-icons text-success">check_circle</span>
          </div>
          <h5 class="fw-800 text-dark">更新が完了しました！</h5>
          <p class="text-muted small mb-0">リストを更新しています...</p>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
