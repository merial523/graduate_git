{% extends base_template %}
{% load static %}

{% block content %}
<div class="container-fluid px-4 py-5" style="background-color: #f4f6f8; min-height: 100vh;">

    <!-- メインフォーム -->
    <form method="post" id="news-form">
        {% csrf_token %}
        
        <div class="row g-4 justify-content-center">
            
            <!-- ==============================
                 LEFT COLUMN: 設定パネル
            ============================== -->
            <div class="col-lg-3">
                <div class="sticky-top" style="top: 2rem;">
                    
                    <!-- 戻るボタン -->
                    <a href="{% url 'moderator:news_list' %}" class="btn btn-link text-decoration-none text-muted mb-3 ps-0 fw-bold small">
                        <i class="bi bi-arrow-left me-1"></i>一覧に戻る
                    </a>

                    <!-- アクションカード -->
                    <div class="card border-0 shadow-sm rounded-4 mb-3 overflow-hidden">
                        <div class="card-body p-4">
                            <h6 class="fw-bold text-dark small mb-4 text-uppercase ls-1">Publish</h6>
                            
                            <!-- ステータススイッチ -->
                            <div class="mb-4">
                                <label class="form-label text-muted extra-small fw-bold">ステータス</label>
                                <div class="d-flex align-items-center justify-content-between p-2 rounded-3 bg-light border transition-all" id="status-box">
                                    <span class="fw-bold small ms-2" id="status-text">下書き</span>
                                    <div class="form-check form-switch m-0">
                                        {{ form.is_active }}
                                    </div>
                                </div>
                            </div>

                            <!-- 重要フラグ -->
                            <div class="mb-4">
                                <label class="form-label text-muted extra-small fw-bold">オプション</label>
                                <div class="form-check p-0 m-0 d-flex align-items-center">
                                    {{ form.is_important }}
                                    <label class="form-check-label ms-2 small text-dark cursor-pointer" for="id_is_important">
                                        重要なお知らせとしてマーク
                                    </label>
                                </div>
                            </div>

                            <hr class="border-light-subtle my-4">

                            <!-- 保存ボタン -->
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-dark rounded-pill py-2 fw-bold shadow-lg hover-elevate">
                                    保存する
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- インフォメーション -->
                    {% if object %}
                    <div class="card border-0 shadow-sm rounded-4 bg-transparent">
                        <div class="card-body p-3 small text-muted">
                            <div class="d-flex justify-content-between mb-2">
                                <span>作成:</span>
                                <span class="fw-bold">{{ object.created_at|date:"Y/m/d" }}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>作成者:</span>
                                <span>{{ object.author.get_full_name|default:object.author.username }}</span>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- ==============================
                 RIGHT COLUMN: エディタエリア
            ============================== -->
            <div class="col-lg-8 col-xl-7">
                <div class="card border-0 shadow-sm rounded-4" style="min-height: 80vh;">
                    <div class="card-body p-5">
                        
                        <!-- タイトル入力 (ボーダーレスで大きく) -->
                        <div class="mb-4">
                            {{ form.title }}
                        </div>

                        <!-- ツールバー風タブ -->
                        <ul class="nav nav-pills mb-4 gap-2" id="editorTab" role="tablist">
                            <li class="nav-item">
                                <button class="nav-link active rounded-pill px-3 py-1 small fw-bold" id="write-tab" data-bs-toggle="tab" data-bs-target="#write-pane" type="button">
                                    <i class="bi bi-pen me-2"></i>書く
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link rounded-pill px-3 py-1 small fw-bold bg-light text-dark" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview-pane" type="button" onclick="updatePreview()">
                                    <i class="bi bi-eye me-2"></i>プレビュー
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content">
                            <!-- 入力エリア -->
                            <div class="tab-pane fade show active" id="write-pane">
                                {{ form.content }}
                                <div class="d-flex justify-content-end mt-2 text-muted extra-small">
                                    <span><i class="bi bi-type"></i> <span id="char-count">0</span> 文字</span>
                                </div>
                            </div>

                            <!-- プレビューエリア -->
                            <div class="tab-pane fade" id="preview-pane">
                                <div class="markdown-preview p-4 bg-light rounded-4">
                                    <!-- 重要バッジ -->
                                    <div id="preview-badge" class="mb-3" style="display: none;">
                                        <span class="badge bg-warning text-dark"><i class="bi bi-star-fill me-1"></i>重要</span>
                                    </div>
                                    <h2 class="fw-bold mb-4 pb-3 border-bottom text-dark" id="preview-title"></h2>
                                    <div id="preview-body" class="text-secondary" style="white-space: pre-wrap; line-height: 1.8;"></div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
    /* タイトル入力のスタイル上書き */
    #id_title {
        border: none;
        border-bottom: 2px solid transparent;
        font-size: 2rem;
        font-weight: 800;
        padding: 0.5rem 0;
        background: transparent;
        transition: border-color 0.3s;
        border-radius: 0;
        box-shadow: none;
    }
    #id_title:focus {
        border-bottom-color: #212529;
        outline: none;
    }
    #id_title::placeholder { color: #dee2e6; }

    /* 本文エリア */
    #id_content {
        border: none;
        width: 100%;
        min-height: 500px;
        resize: none;
        outline: none;
        font-size: 1.05rem;
        line-height: 1.8;
        color: #495057;
    }
    #id_content:focus { box-shadow: none; }

    /* UIパーツ */
    .ls-1 { letter-spacing: 1px; }
    .extra-small { font-size: 0.75rem; }
    .hover-elevate:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important; transition: all 0.2s; }
    .cursor-pointer { cursor: pointer; }

    /* スイッチ & チェックボックスの微調整 */
    .form-check-input { cursor: pointer; }
    #status-box.active { background-color: #d1e7dd !important; border-color: #badbcc !important; color: #0f5132; }
    
    /* タブのアクティブスタイル */
    .nav-pills .nav-link.active { background-color: #212529; color: #fff; }
</style>

<script>
    // タイトル入力に合わせてプレビュータイトル更新
    function updatePreview() {
        const title = document.getElementById('id_title').value;
        const content = document.getElementById('id_content').value;
        const isImportant = document.getElementById('id_is_important').checked;

        document.getElementById('preview-title').innerText = title || '（タイトル未入力）';
        document.getElementById('preview-body').innerText = content || '（本文がありません）';
        document.getElementById('preview-badge').style.display = isImportant ? 'block' : 'none';
    }

    // ステータスの見た目切り替え
    const statusSwitch = document.getElementById('id_is_active');
    const statusBox = document.getElementById('status-box');
    const statusText = document.getElementById('status-text');

    function updateStatusUI() {
        if(statusSwitch.checked) {
            statusBox.classList.add('active');
            statusText.innerText = "公開中";
        } else {
            statusBox.classList.remove('active');
            statusText.innerText = "下書き";
        }
    }

    if(statusSwitch) {
        statusSwitch.addEventListener('change', updateStatusUI);
        updateStatusUI(); // 初期実行
    }

    // 文字数カウント
    document.getElementById('id_content').addEventListener('input', function() {
        document.getElementById('char-count').innerText = this.value.length;
    });
</script>
{% endblock %}