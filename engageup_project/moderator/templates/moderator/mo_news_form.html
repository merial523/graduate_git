{% extends base_template %}
{% load static %}

{% block content %}
<div class="user-management-container pb-5">
    
    <!-- タイトルエリア -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="page-title text-dark m-0 fw-bold">
            {% if object %}お知らせの編集{% else %}新規お知らせ作成{% endif %}
        </h1>
        <!-- 保存ボタンを右上に配置 -->
        <button type="button" onclick="document.getElementById('news-form').submit()" class="btn btn-primary shadow-sm rounded-pill px-4 fw-bold">
            <span class="material-icons size-18 align-middle me-1">save</span> 保存する
        </button>
    </div>

    <form method="post" id="news-form">
        {% csrf_token %}
        <div class="row g-4">
            
            <!-- LEFT COLUMN: 設定パネル -->
            <div class="col-lg-4">
                <div class="admin-card border-0 shadow-sm rounded-4 p-4 bg-white">
                    <h5 class="fw-bold mb-4 text-dark border-bottom pb-2">基本設定</h5>
                    
                    <!-- 重要フラグ -->
                    <div class="mb-4 p-3 rounded-3" style="background-color: #fff4e6; border: 1px solid #ffe8cc;">
                        <div class="form-check form-switch">
                            {{ form.is_important }}
                            <label class="form-check-label fw-bold ms-2 text-dark" for="id_is_important">
                                重要なお知らせ
                            </label>
                        </div>
                        <div class="form-text extra-small mt-2 text-muted">
                            ONにすると一覧で強調表示され、ユーザーの目に留まりやすくなります。
                        </div>
                    </div>

                    <!-- 公開ステータス -->
                    <div class="mb-4">
                        <label class="form-label fw-bold text-dark">公開ステータス</label>
                        <div class="form-check form-switch custom-switch-lg">
                            {{ form.is_active }}
                            <label class="form-check-label fw-bold ms-2" for="id_is_active" id="status-label">
                                {% if form.is_active.value %}公開中{% else %}非公開{% endif %}
                            </label>
                        </div>
                    </div>

                    <!-- 作成者情報 (編集時のみ) -->
                    {% if object %}
                    <div class="mt-4 pt-3 border-top">
                        <div class="d-flex justify-content-between mb-2 extra-small text-muted">
                            <span>作成者:</span>
                            <span class="fw-bold">{{ object.author.get_full_name|default:object.author.username }}</span>
                        </div>
                        <div class="d-flex justify-content-between extra-small text-muted">
                            <span>作成日時:</span>
                            <span>{{ object.created_at|date:"Y/m/d H:i" }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- RIGHT COLUMN: エディタ -->
            <div class="col-lg-8">
                <div class="admin-card border-0 shadow-sm rounded-4 p-4 bg-white h-100">
                    
                    <!-- タイトル入力 -->
                    <div class="mb-4">
                        <label class="form-label fw-bold text-dark">タイトル <span class="text-danger">*</span></label>
                        {{ form.title }}
                    </div>

                    <!-- 本文入力 -->
                    <div class="mb-2">
                        <label class="form-label fw-bold text-dark">内容 <span class="text-danger">*</span></label>
                        <!-- プレビュー切り替えタブ -->
                        <ul class="nav nav-tabs border-bottom-0 mb-2" id="myTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active rounded-top-3 px-3 py-1 small fw-bold" id="edit-tab" data-bs-toggle="tab" data-bs-target="#edit-pane" type="button">編集</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link rounded-top-3 px-3 py-1 small fw-bold" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview-pane" type="button" onclick="updatePreview()">プレビュー</button>
                            </li>
                        </ul>
                        
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="edit-pane">
                                {{ form.content }}
                            </div>
                            <div class="tab-pane fade" id="preview-pane">
                                <div class="p-3 bg-light rounded-3 border" style="min-height: 300px;" id="preview-content">
                                    (ここにプレビューが表示されます)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
    /* フォームスタイル (ねこねこ薬局統一) */
    .admin-card { background: white; }
    
    /* 入力フォームの丸みと枠線 */
    input[type="text"], textarea {
        border-radius: 12px;
        border: 1px solid #dee2e6;
        padding: 12px 16px;
        width: 100%;
        background-color: #fcfcfc;
    }
    input[type="text"]:focus, textarea:focus {
        background-color: #fff;
        border-color: #76b19d; /* テーマカラー */
        outline: none;
        box-shadow: 0 0 0 3px rgba(118, 177, 157, 0.2);
    }
    textarea { min-height: 400px; resize: vertical; }

    /* トグルスイッチ */
    .custom-switch-lg { padding-left: 0; display: flex; align-items: center; }
    .custom-switch-lg .form-check-input {
        width: 3rem; height: 1.5rem; margin: 0; cursor: pointer; float: none;
        background-color: #ced4da; border: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='white'/%3e%3c/svg%3e");
        transition: background-position .15s ease-in-out;
    }
    .custom-switch-lg .form-check-input:checked { background-color: #2ecc71; }

    /* タブスタイル */
    .nav-tabs .nav-link { color: #6c757d; border: none; background: transparent; }
    .nav-tabs .nav-link.active { color: #333; background: #f0f0f0; }
</style>

<script>
    // プレビュー機能
    function updatePreview() {
        const content = document.getElementById('id_content').value;
        // 改行を<br>に変換（簡易的）
        document.getElementById('preview-content').innerHTML = content.replace(/\n/g, '<br>');
    }

    // 公開/非公開のラベル切り替え
    const statusCheck = document.getElementById('id_is_active');
    const statusLabel = document.getElementById('status-label');
    if(statusCheck) {
        statusCheck.addEventListener('change', function() {
            if(this.checked) {
                statusLabel.innerText = "公開中";
                statusLabel.classList.replace("text-muted", "text-success");
            } else {
                statusLabel.innerText = "非公開";
                statusLabel.classList.replace("text-success", "text-muted");
            }
        });
    }
</script>
{% endblock %}