{% extends base_template %}
{% load static %}
{% block title %}アカウント一括作成 | EngageUp{% endblock %}
{% block breadcrumb %}
<li class="breadcrumb-item">
  <a href="{% url 'administer:user_list' %}">ユーザー管理</a>
</li>
<li class="breadcrumb-item active" aria-current="page">一括作成</li>
{% endblock %} {% block content %}
<div class="user-management-container pb-5">
  <div class="mb-4">
    <h1 class="page-title text-dark m-0 fw-800">アカウント一括作成</h1>
  </div>

  <div class="admin-card border-0 shadow-sm overflow-visible">
    <div class="card-body p-4">
      <form method="post" id="create-user-form">
        {% csrf_token %} {% if form.non_field_errors %}
        <div class="alert alert-danger rounded-4 shadow-sm mb-4">
          {{ form.non_field_errors }}
        </div>
        {% endif %}

        <div class="row g-4 align-items-start">
          <div class="col-lg-8">
            <div class="row g-3">
              <!-- 開始番号 -->
              <div class="col-md-4">
                <label
                  class="form-label fw-800 d-flex align-items-center gap-2 mb-2"
                >
                  <span class="material-icons text-primary"
                    >format_list_numbered</span
                  >
                  開始番号
                </label>
                <div class="custom-input-group">{{ form.start_number }}</div>
                <div class="small text-danger mt-1">
                  {{ form.start_number.errors }}
                </div>
              </div>

              <!-- 作成人数 -->
              <div class="col-md-4">
                <label
                  class="form-label fw-800 d-flex align-items-center gap-2 mb-2"
                >
                  <span class="material-icons text-primary">group_add</span>
                  作成人数
                </label>
                <div class="custom-input-group">{{ form.count }}</div>
                <div class="small text-danger mt-1">
                  {{ form.count.errors }}
                </div>
              </div>
            </div>
          </div>

          <!-- ランク選択 -->
          <!-- <div class="col-lg-4">
            <label
              class="form-label fw-800 d-flex align-items-center gap-2 mb-2"
            >
              <span class="material-icons text-primary">stars</span>
              ランク
            </label>
            <div class="custom-radio-group">{{ form.rank }}</div>
            <div class="small text-danger mt-1">{{ form.rank.errors }}</div>
          </div> -->
        </div>

        <div
          class="mt-5 pt-4 border-top d-flex justify-content-between align-items-center"
        >
          <div class="d-flex gap-3">
            <span class="material-icons text-green">info</span>
                <div class="text-green small">
                    <strong>ヒント:</strong> 生成されるユーザーIDの例：<br>
                    企業コードが「ENG」、開始番号が「101」の場合 → <br>
                    <strong>ENG101, ENG102...</strong> となります。
                </div>
          </div>
          <div class="d-flex gap-3">
            <a
              href="{% url 'administer:user_list' %}"
              class="btn btn-light px-4 border rounded-pill"
              >キャンセル</a
            >
            <button
              type="button"
              id="submit-btn"
              class="btn btn-primary px-5 fw-800 shadow-sm"
            >
              <span class="material-icons me-2">person_add</span>作成する
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 処理中/完了モーダル -->
<div
  class="modal fade"
  id="statusModal"
  tabindex="-1"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-5">
      <div class="modal-body text-center p-5">
        <div id="modal-loading">
          <div class="custom-loader mb-4"></div>
          <h5 class="fw-800 text-primary">ユーザーを作成中...</h5>
        </div>
        <div id="modal-success" style="display: none">
          <div class="success-icon-wrapper mb-4">
            <span class="material-icons text-success" style="font-size: 80px"
              >check_circle</span
            >
          </div>
          <h5 class="fw-800 text-dark">作成が完了しました！</h5>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 警告用モーダル -->
<div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content border-0 shadow-lg rounded-5">
      <div class="modal-body text-center p-5">
        <div class="mb-4">
          <span class="material-icons text-warning" style="font-size: 64px"
            >warning_amber</span
          >
        </div>
        <h5 class="fw-800 text-dark mb-3">入力が必要です</h5>
        <!-- ここに日本語の項目名だけが入ります -->
        <p class="text-muted small mb-4" id="alert-modal-msg"></p>
        <button
          type="button"
          class="btn btn-primary rounded-pill px-5 shadow-sm"
          data-bs-dismiss="modal"
        >
          了解
        </button>
      </div>
    </div>
  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("create-user-form");
  const submitBtn = document.getElementById("submit-btn");

  const statusModal = new bootstrap.Modal(
    document.getElementById("statusModal")
  );
  const alertModal = new bootstrap.Modal(
    document.getElementById("alertModal")
  );
  const alertMsg = document.getElementById("alert-modal-msg");

  submitBtn.addEventListener("click", function () {

    // ===== 必須チェック（今まで通り）=====
    const requiredFields = form.querySelectorAll("[required]");
    let missingNames = [];

    requiredFields.forEach((field) => {
      if (!field.value.trim()) {
        const container = field.closest(".col-md-4");
        const labelEl = container?.querySelector(".form-label");
        if (labelEl) {
          missingNames.push(labelEl.innerText.trim());
        }
      }
    });

    if (missingNames.length > 0) {
      alertMsg.innerHTML =
        "以下の項目を入力してください：<br><strong>" +
        missingNames.join(", ") +
        "</strong>";
      alertModal.show();
      return;
    }

    // ===== 重複チェック（Ajax）=====
    const formData = new FormData(form);

    fetch("{% url 'moderator:check_user_duplicate' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
      },
      body: formData,
    })
    .then(res => res.json())
    .then(data => {
      if (!data.ok) {
        alertMsg.innerHTML =
          "以下のユーザーは既に存在します：<br><strong class='text-danger'>" +
          data.duplicates.join(", ") +
          "</strong>";
        alertModal.show();
        return;
      }

      // ===== 問題なければ初めてローディング =====
      statusModal.show();

      setTimeout(() => {
        document.getElementById("modal-loading").style.display = "none";
        document.getElementById("modal-success").style.display = "block";
        setTimeout(() => {
          form.submit();
        }, 800);
      }, 1200);
    });
  });
});
</script>


<style>
  .fw-800 {
    font-weight: 800;
  }
  /* ローディング画面 */
    .custom-loader { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; display: inline-block; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .custom-input-group input {
    display: block;
    width: 100%;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    color: var(--text-color);
    background-color: var(--bg-color);
    border: 2px solid transparent;
    border-radius: 12px;
    transition: all 0.3s ease;
  }
  .custom-input-group input:focus {
    background-color: #fff;
    border-color: var(--primary-color);
    outline: 0;
    box-shadow: 0 0 0 4px rgba(118, 177, 157, 0.15);
  }
  .custom-radio-group ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  .custom-radio-group li {
    background: var(--bg-color);
    padding: 8px 16px;
    border-radius: 10px;
    cursor: pointer;
    transition: 0.2s;
    border: 2px solid transparent;
  }
  .custom-radio-group li:has(input:checked) {
    background: #fff;
    border-color: var(--primary-color);
    color: var(--primary-color);
    font-weight: bold;
  }
  .custom-radio-group label {
    cursor: pointer;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .custom-radio-group input[type="radio"] {
    margin: 0;
    accent-color: var(--primary-color);
  }
  .text-green {
    color: #5a8a7a;
  }
</style>
{% endblock %}
