{% extends base_template %}
{% load static %}
{% block breadcrumb %}<li class="breadcrumb-item active">お知らせ管理</li>{% endblock %}

{% block content %}
<div class="user-management-container pb-5">
    
    <!-- タイトルエリア -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="page-title text-dark m-0 fw-bold">
            お知らせ管理
        </h1>
        <div class="display-toggle">
            {% if is_trash_mode %}
            <a href="{% url 'moderator:news_list' %}" class="btn btn-outline-secondary btn-sm rounded-pill px-3 shadow-sm bg-white">
                <span class="material-icons fw-bold small align-middle">visibility</span>有効なお知らせ
            </a>
            {% else %}
            <a href="?show=deleted" class="btn btn-outline-dark btn-sm rounded-pill px-3 shadow-sm bg-white">
                <span class="material-icons fw-bold small align-middle">delete</span> 削除済みを表示
            </a>
            {% endif %}
        </div>
    </div>

    <!-- コントロールパネル -->
    <div class="row g-3 mb-4 align-items-center">
        <div class="col-xl-12">
            <form method="get" id="filter-form" class="d-flex gap-2 align-items-center flex-wrap">
                <!-- 検索 -->
                <div class="search-input-group shadow-sm bg-white border" style="width: 280px;">
                    <span class="material-icons text-muted">search</span>
                    <input type="text" name="q" placeholder="お知らせを検索..." value="{{ search_query }}" />
                </div>

                <!-- 並べ替え -->
                <select name="sort" class="form-select border shadow-sm rounded-pill px-3" style="width: 140px;" onchange="this.form.submit()">
                    <option value="newest" {% if current_sort == 'newest' %}selected{% endif %}>新しい順</option>
                    <option value="oldest" {% if current_sort == 'oldest' %}selected{% endif %}>古い順</option>
                    <option value="important" {% if current_sort == 'important' %}selected{% endif %}>重要度順</option>
                </select>

                <!-- フィルタ -->
                <div class="segment-filter shadow-sm bg-white border p-1 d-flex">
                    <input type="radio" name="status" value="all" id="st-all" class="d-none" onchange="this.form.submit()" {% if current_status == 'all' %}checked{% endif %}>
                    <label for="st-all" class="segment-item">全て</label>
                    <input type="radio" name="status" value="public" id="st-public" class="d-none" onchange="this.form.submit()" {% if current_status == 'public' %}checked{% endif %}>
                    <label for="st-public" class="segment-item segment-public">公開中</label>
                    <input type="radio" name="status" value="private" id="st-private" class="d-none" onchange="this.form.submit()" {% if current_status == 'private' %}checked{% endif %}>
                    <label for="st-private" class="segment-item segment-private">非公開</label>
                </div>

                {% if is_trash_mode %}<input type="hidden" name="show" value="deleted">{% endif %}

                <!-- 新規作成ボタン -->
                <div class="ms-auto d-flex align-items-center">
                    {% if not is_trash_mode %}
                    <a href="{% url 'moderator:news_create' %}" class="btn btn-primary shadow-sm rounded-pill px-4 fw-bold d-flex align-items-center">
                        <span class="material-icons me-1">add</span> 新規作成
                    </a>
                    {% endif %}
                    <!-- <a href="#" class="text-muted small text-decoration-none ms-3 d-inline-flex align-items-center help-trigger">
                        <span class="material-icons size-18 me-1">help_outline</span> ヘルプ
                    </a> -->
                </div>
            </form>
        </div>
    </div>

    <!-- リストエリア -->
    <form action="{% url 'moderator:news_bulk_action' %}" method="post" id="bulk-form">
        {% csrf_token %}
        <input type="hidden" name="action" id="bulk-action-input" value="">

        <div class="news-grid">
            {% for news in news_list %}
            <div class="exam-list-item user-row mb-3" data-id="{{ news.id }}" id="news-{{ news.id }}" style="cursor: pointer;">
                <div class="admin-card border-0 shadow-sm rounded-4 p-3 bg-white position-relative exam-card-accent {% if news.is_important %}accent-important{% else %}accent-normal{% endif %}">
                    
                    <div class="d-flex align-items-center card-main-row">
                        <!-- チェックボックス -->
                        <div class="pe-3 ps-2">
                            <input type="checkbox" name="news_ids" value="{{ news.id }}" class="form-check-input row-checkbox scale-110" />
                        </div>

                        <!-- アイコンエリア -->
                        <div class="course-thumb-container me-3 d-none d-md-flex shadow-sm {% if news.is_important %}bg-warning text-dark{% else %}bg-secondary text-white{% endif %}">
                            <span class="material-icons">campaign</span>
                        </div>

                        <!-- メイン情報 -->
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <span class="badge-cute {% if news.is_important %}badge-orange{% else %}badge-gray{% endif %}">
                                    {% if news.is_important %}重要{% else %}お知らせ{% endif %}
                                </span>
                                <span class="badge-cute badge-status-active {% if not news.is_active %}d-none{% endif %}">公開中</span>
                                <span class="badge-cute badge-status-inactive {% if news.is_active %}d-none{% endif %}">非公開</span>
                                <span class="text-muted extra-small ms-1">ID: #{{ news.id }}</span>
                            </div>
                            
                            <h3 class="h6 fw-bold text-dark mb-1 d-flex align-items-center">
                                <a href="{% url 'moderator:news_update' news.id %}" class="text-dark text-decoration-none hover-underline stop-propagation">
                                    {{ news.title }}
                                </a>
                            </h3>
                            
                            <p class="text-muted small mb-1 text-truncate" style="max-width: 600px;">
                                {{ news.content|striptags|truncatechars:50 }}
                            </p>
                            
                            <!-- メタ情報 -->
                            <div class="extra-small text-muted d-flex gap-3 align-items-center">
                                <span><i class="bi bi-clock me-1"></i>作成日: {{ news.created_at|date:"Y/m/d" }}</span>
                                <span>
                                    <i class="bi bi-person me-1"></i>
                                    {% if news.author %}
                                        {{ news.author.get_full_name|default:news.author.username }}
                                    {% else %}
                                        管理者
                                    {% endif %}
                                </span>
                            </div>
                        </div>

                        <!-- トグルスイッチ & メニュー -->
                        <div class="d-flex align-items-center gap-3 pe-2 position-relative" style="z-index: 5;">
                            {% if not is_trash_mode %}
                            <div class="toggle-center-container stop-propagation">
                                <div class="form-check form-switch custom-switch-cute">
                                    <input class="form-check-input toggle-active-switch" type="checkbox" 
                                           data-url="{% url 'moderator:news_toggle_active' news.id %}"
                                           {% if news.is_active %}checked{% endif %}>
                                    <label class="status-label fw-bold {% if news.is_active %}text-success{% else %}text-muted{% endif %}">
                                        {% if news.is_active %}公開中{% else %}非公開{% endif %}
                                    </label>
                                </div>
                            </div>
                            {% endif %}

                            <div class="action-area dropdown stop-propagation">
                                <button class="btn btn-light rounded-circle p-2 border shadow-sm" type="button" data-bs-toggle="dropdown">
                                    <span class="material-icons text-secondary">more_vert</span>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end shadow border-0 rounded-4 p-2">
                                    {% if not is_trash_mode %}
                                    <li><a class="dropdown-item rounded-3 fw-bold" href="{% url 'moderator:news_update' news.id %}">
                                        <span class="material-icons size-18 me-2 text-primary">edit</span>編集
                                    </a></li>
                                    <li><hr class="dropdown-divider my-2"></li>
                                    <li><button type="button" class="dropdown-item rounded-3 text-danger fw-bold action-trigger" data-action="delete" data-id="{{ news.id }}">
                                        <span class="material-icons size-18 me-2">delete</span>削除
                                    </button></li>
                                    {% else %}
                                    <li><button type="button" class="dropdown-item rounded-3 text-success fw-bold action-trigger" data-action="restore" data-id="{{ news.id }}">
                                        <span class="material-icons size-18 me-2">restore_from_trash</span>復元
                                    </button></li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="admin-card border-0 shadow-sm rounded-4 py-5 text-center text-muted bg-white">
                <span class="material-icons" style="font-size: 48px; opacity: 0.3;">search_off</span>
                <p class="fw-bold mt-2">お知らせが見つかりません</p>
            </div>
            {% endfor %}
        </div>

        <!-- フローティング・アクションバー -->
        <div class="action-bar-container" id="floating-action-bar">
            <div class="action-bar-inner shadow-lg mx-3 mb-3 rounded-pill border-0 bg-dark text-white">
                <div class="container-fluid px-4 py-2">
                    <div class="row align-items-center">
                        <div class="col-md-auto">
                            <div class="selection-count py-1 d-flex align-items-center">
                                <span class="material-icons text-primary me-2">how_to_reg</span>
                                <span id="selected-count-display" class="fw-bold fs-5 me-2 text-primary">0</span> 件を選択中
                            </div>
                        </div>
                        <div class="col text-end">
                            <div class="d-flex gap-2 justify-content-end">
                                {% if is_trash_mode %}
                                <button type="button" class="btn btn-warning btn-sm rounded-pill px-4 fw-bold action-trigger" data-action="restore" data-msg="一括復元しています...">一括復元</button>
                                {% else %}
                                <button type="button" class="btn btn-outline-light btn-sm rounded-pill px-3 fw-bold action-trigger" data-action="make_public" data-msg="一括公開しています...">一括公開</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm rounded-pill px-3 fw-bold action-trigger" data-action="make_private" data-msg="一括非公開しています...">一括非公開</button>
                                <button type="button" class="btn btn-danger btn-sm rounded-pill px-4 fw-bold action-trigger" data-action="delete" data-msg="一括削除しています...">一括削除</button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- モーダル類 -->
<div class="modal fade" id="statusModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow-lg rounded-5"><div class="modal-body text-center p-5"><div id="modal-loading"><div class="custom-loader mb-4"></div><h5 class="fw-bold" id="loading-text">処理中...</h5></div><div id="modal-success" style="display: none;"><span class="material-icons text-success" style="font-size: 60px;">check_circle</span><h5 class="fw-bold mt-3">完了しました</h5></div></div></div></div></div>
<div class="modal fade" id="confirmModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow-lg rounded-5"><div class="modal-header border-0 pt-4 px-4"><h5 class="modal-title fw-bold" id="confirmTitle">確認</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body px-4"><p id="confirmBody" class="fw-bold mb-1">選択した項目を削除しますか？</p></div><div class="modal-footer border-0 pb-4 px-4"><button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">キャンセル</button><button type="button" class="btn btn-danger rounded-pill px-4 fw-bold" id="confirmExecuteBtn">実行する</button></div></div></div></div>

<style>
    /* 共通設定 */
    .fw-bold { font-weight: 700; }
    .extra-small { font-size: 0.72rem; }
    .size-18 { font-size: 18px; }
    .hover-underline:hover { text-decoration: underline !important; }
    
    /* カードデザイン */
    .admin-card { 
        overflow: visible !important; 
        position: relative; /* 重なりの基準にする */
        z-index: 1;
    }

    /* ★追加: トグルとメニューを最前面に表示するクラス */
    .action-area {
        position: relative;
        z-index: 100; /* 行クリック判定や他の装飾より確実に上にする */
    }

    .exam-card-accent::before {
        content: ""; position: absolute; top: 0; left: 0; bottom: 0; width: 6px;
        border-top-left-radius: inherit; border-bottom-left-radius: inherit;
    }
    .accent-normal::before { background-color: #5ea8e6; } 
    .accent-important::before { background-color: #fd7e14; } 
    
    .table-selected .admin-card { background-color: #f1f9f6 !important; border: 1.5px solid #76b19d !important; }

    /* サムネイルアイコン */
    .course-thumb-container {
        width: 48px; height: 48px; border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
    }

    /* バッジ */
    .badge-cute { font-size: 0.7rem; padding: 3px 10px; border-radius: 6px; font-weight: bold; }
    .badge-orange { background: #fff4e6; color: #fd7e14; border: 1px solid #ffe8cc; }
    .badge-gray { background: #f8f9fa; color: #495057; border: 1px solid #dee2e6; }
    .badge-status-active { background: #e8fcf1; color: #2ecc71; border: 1px solid #d4f7e4; }
    .badge-status-inactive { background: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6; }

    /* 検索窓 & フィルタ */
    .search-input-group { border-radius: 50px; padding: 6px 15px; display: flex; align-items: center; border: 1px solid rgba(0,0,0,0.1); background: white;}
    .search-input-group input { border: none; outline: none; background: transparent; margin-left: 8px; width: 100%; }
    .segment-filter { border-radius: 50px; }
    .segment-item { padding: 6px 18px; border-radius: 50px; cursor: pointer; font-size: 0.85rem; font-weight: bold; transition: 0.2s; margin: 0 2px; }
    #st-all:checked + label { background: #555; color: white; }
    #st-public:checked + label { background: #2ecc71; color: white; }
    #st-private:checked + label { background: #6c757d; color: white; }

    /* トグルスイッチ */
    .custom-switch-cute { display: flex !important; flex-direction: column !important; align-items: center !important; }
    .custom-switch-cute .form-check-input {
        width: 3rem !important; height: 1.5rem !important; margin: 0 0 4px 0 !important; cursor: pointer; float: none !important; border-radius: 2rem !important;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='white'/%3e%3c/svg%3e") !important;
        background-color: #ced4da; border-color: #ced4da; opacity: 1 !important;
    }
    .custom-switch-cute .form-check-input:checked { background-color: #76b19d !important; border-color: #76b19d !important; }
    .status-label { font-size: 0.75rem; margin: 0 !important; white-space: nowrap; }

    /* フローティング・アクションバーのスタイル */
    .action-bar-container {
        position: fixed;
        bottom: 0;
        left: var(--sidebar-width, 260px); 
        width: calc(100% - var(--sidebar-width, 260px));
        z-index: 1000;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        transform: translateY(100px);
        opacity: 0;
        pointer-events: none;
    }
    .action-bar-container.active {
        transform: translateY(0);
        opacity: 1;
        pointer-events: auto;
    }
    .action-bar-inner { background: #2d3436 !important; }

    /* サイドバー折りたたみ時との連動 */
    .sidebar-collapsed .action-bar-container {
        left: var(--sidebar-collapsed-width, 88px);
        width: calc(100% - var(--sidebar-collapsed-width, 88px));
    }

    /* ローダー */
    .custom-loader { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; display: inline-block; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const actionBar = document.getElementById('floating-action-bar');
    const countDisplay = document.getElementById('selected-count-display');
    const statusModal = new bootstrap.Modal(document.getElementById('statusModal'));
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    const bulkForm = document.getElementById('bulk-form');
    const actionInput = document.getElementById('bulk-action-input');
    const confirmExecuteBtn = document.getElementById('confirmExecuteBtn');

    // 選択状態更新
    function updateSelection() {
        const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
        if (countDisplay) countDisplay.innerText = checkedCount;
        if (actionBar) {
            if (checkedCount > 0) actionBar.classList.add('active');
            else actionBar.classList.remove('active');
        }
    }

    // 行クリック処理
    document.querySelectorAll('.exam-list-item').forEach(item => {
        item.addEventListener('click', function(e) {
            if (e.target.closest('.stop-propagation') || e.target.type === 'checkbox') return;
            
            const cb = this.querySelector('.row-checkbox');
            if (cb) {
                cb.checked = !cb.checked;
                this.querySelector('.admin-card').classList.toggle('table-selected', cb.checked);
                updateSelection();
            }
        });
    });

    // チェックボックス変更処理
    document.querySelectorAll('.row-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
            this.closest('.admin-card').classList.toggle('table-selected', this.checked);
            updateSelection();
        });
    });

    // リアルタイムトグル
    document.querySelectorAll('.toggle-active-switch').forEach(sw => {
        sw.addEventListener('change', function() {
            const url = this.dataset.url;
            const label = this.closest('.custom-switch-cute').querySelector('.status-label');
            const card = this.closest('.admin-card');
            const activeBadge = card.querySelector('.badge-status-active');
            const inactiveBadge = card.querySelector('.badge-status-inactive');
            
            const isActive = this.checked;
            label.innerText = isActive ? "公開中" : "非公開";
            label.className = `status-label fw-bold ${isActive ? 'text-success' : 'text-muted'}`;
            
            if (isActive) {
                activeBadge.classList.remove('d-none');
                inactiveBadge.classList.add('d-none');
            } else {
                activeBadge.classList.add('d-none');
                inactiveBadge.classList.remove('d-none');
            }

            fetch(url, {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' }
            });
        });
    });

    // アクションボタン処理
    document.querySelectorAll('.action-trigger').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const action = this.dataset.action;
            const id = this.dataset.id;
            
            if (id) {
                document.querySelectorAll('.row-checkbox').forEach(cb => {
                    cb.checked = false;
                    cb.closest('.admin-card').classList.remove('table-selected');
                });
                const targetCb = document.querySelector(`.row-checkbox[value="${id}"]`);
                if (targetCb) {
                    targetCb.checked = true;
                }
            }

            // 確認モーダル設定
            const isDelete = (action === 'delete');
            actionInput.value = action;
            document.getElementById('confirmBody').innerText = isDelete 
                ? '選択したお知らせをゴミ箱へ移動しますか？' 
                : '選択したお知らせを復元しますか？';
            document.getElementById('confirmTitle').innerText = isDelete ? '削除の確認' : '復元の確認';
            
            const execBtn = document.getElementById('confirmExecuteBtn');
            execBtn.className = isDelete ? 'btn btn-danger rounded-pill px-4 fw-bold' : 'btn btn-success rounded-pill px-4 fw-bold';
            execBtn.innerText = isDelete ? '削除する' : '復元する';
            
            confirmModal.show();
        });
    });

    // 実行ボタン
    confirmExecuteBtn.addEventListener('click', function() {
        confirmModal.hide();
        document.getElementById('loading-text').innerText = '処理しています...';
        statusModal.show();
        setTimeout(() => {
            document.getElementById('modal-loading').style.display = 'none';
            document.getElementById('modal-success').style.display = 'block';
            setTimeout(() => bulkForm.submit(), 800);
        }, 800);
    });
});
</script>
{% endblock %}