{% extends base_template %}
{% load static %}

{% block title %}{{ module.title }} | 研修受講{% endblock %}

{% block content %}
<div class="user-exam-container pb-5">
    
    <!-- 1. ヘッダー：タイトルセクション -->
    <div class="mb-4 d-flex justify-content-between align-items-end flex-wrap gap-2">
        <div>
            <h1 class="page-title text-dark m-0 fw-800">{{ module.title }}</h1>
            <div class="d-flex align-items-center gap-2 mt-2">
                <span class="badge-time">
                    <span class="material-icons size-14">timer</span> 目安 {{ module.estimated_time }}分
                </span>
                {% if is_completed %}
                <span class="badge-status-done">
                    <span class="material-icons size-14 align-middle">check_circle</span> 受講完了
                </span>
                {% endif %}
            </div>
        </div>
        <div class="text-end">
            <span class="extra-small text-muted d-block">現在の視聴状況</span>
            <span id="progressText" class="fw-800 text-primary fs-5">0%</span>
        </div>
    </div>

    <!-- 2. 動画セクション (16:9固定) -->
    <div class="video-fixed-wrapper mb-5">
        <div class="video-aspect-container shadow-lg">
            {% if module.video %}
            <video id="trainingVideo" controls playsinline poster="{% if module.thumbnail %}{{ module.thumbnail.url }}{% endif %}">
                <source src="{{ module.video.url }}" type="video/mp4">
            </video>
            {% else %}
            <div class="video-placeholder">
                <span class="material-icons">videocam_off</span>
                <p>動画を準備しています</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- 3. 学習コンテンツエリア -->
    <div class="row g-4">
        
        <!-- 研修のポイント ＆ PDF資料 -->
        <div class="col-12">
            <div class="admin-card border-0 shadow-sm bg-white">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="h5 fw-800 m-0 d-flex align-items-center gap-2">
                        <span class="material-icons text-primary">menu_book</span>
                        研修のポイント
                    </h2>
                    <!-- ★ PDF資料を開くボタン -->
                    {% if module.reference_pdf %}
                    <a href="{{ module.reference_pdf.url }}" target="_blank" class="btn btn-primary btn-sm rounded-pill extra-small fw-bold px-4 shadow-sm d-flex align-items-center gap-1">
                        <span class="material-icons size-16">picture_as_pdf</span>
                        PDF資料を開く
                    </a>
                    {% endif %}
                </div>
                <div class="training-content-body text-dark">
                    {{ module.content_text|safe|default:"この研修に要約資料はありません。動画およびPDF資料を確認してください。" }}
                </div>
            </div>
        </div>

        <!-- 理解度チェック -->
        <div class="col-12">
            <div class="admin-card border-0 shadow-sm bg-white">
                <h2 class="h5 fw-800 mb-4 d-flex align-items-center gap-2">
                    <span class="material-icons text-warning">lightbulb</span>
                    理解度チェック（何度でも挑戦可能）
                </h2>
                
                <div class="quiz-stack">
                    {% for example in module.examples.all %}
                    <div class="quiz-item-card p-4 rounded-4 mb-4">
                        <p class="extra-small fw-bold text-primary mb-1">例題 {{ forloop.counter }}</p>
                        <p class="fw-bold text-dark mb-4" style="font-size: 1.1rem;">{{ example.text }}</p>
                        <div class="row g-3">
                            {% for choice in example.choices.all %}
                            <div class="col-md-6">
                                <button class="quiz-choice-btn w-100" onclick="checkAnswer(this, {{ choice.is_correct|yesno:'true,false' }})">
                                    {{ choice.text }}
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="explanation-box mt-4 p-3 rounded-4 bg-white border d-none">
                            <div class="res-label fw-800 mb-2"></div>
                            <div class="small text-muted" style="line-height: 1.6;">
                                <strong class="text-dark">【解説】</strong><br>
                                {{ example.explanation }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- 4. ページ最下部：ナビゲーション ＆ 保存ボタン -->
    <div class="mt-5 pt-5 border-top">
        <!-- 前後の研修へのリンク -->
        <div class="row g-3 mb-5 justify-content-center">
            <div class="col-6 col-md-4">
                {% if prev_module %}
                <a href="{% url 'courses:training_detail' prev_module.id %}" class="nav-step-btn prev w-100">
                    <span class="material-icons">arrow_back</span>
                    <div class="text-start ms-2">
                        <span class="extra-small d-block opacity-75">前の研修</span>
                        <span class="small fw-bold text-truncate d-block" style="max-width: 120px;">{{ prev_module.title }}</span>
                    </div>
                </a>
                {% endif %}
            </div>
            <div class="col-6 col-md-4">
                {% if next_module %}
                <a href="{% url 'courses:training_detail' next_module.id %}" class="nav-step-btn next w-100">
                    <div class="text-end me-2">
                        <span class="extra-small d-block opacity-75">次の研修</span>
                        <span class="small fw-bold text-truncate d-block" style="max-width: 120px;">{{ next_module.title }}</span>
                    </div>
                    <span class="material-icons">arrow_forward</span>
                </a>
                {% endif %}
            </div>
        </div>

        <div class="text-center">
            <button type="button" id="saveExitBtn" class="btn btn-success rounded-pill px-5 py-3 fw-800 shadow-lg" onclick="saveAndExit()">
                <span class="material-icons me-2 align-middle">task_alt</span>
                学習を完了して一覧へ戻る
            </button>
        </div>
    </div>

</div>

<style>
    .page-title { font-size: 1.4rem; border-left: 5px solid var(--primary-color); padding-left: 15px; font-weight: 800; }
    .fw-800 { font-weight: 800 !important; }
    .extra-small { font-size: 0.72rem; }
    .badge-time { background: #eef7f4; color: var(--primary-color); padding: 4px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 800; display: inline-flex; align-items: center; gap: 4px; }
    .badge-status-done { background: #2ecc71; color: white; padding: 4px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 800; }

    /* 動画 */
    .video-aspect-container { position: relative; width: 100%; aspect-ratio: 16 / 9; background: #000; border-radius: 28px; overflow: hidden; }
    .video-aspect-container video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; }

    /* クイズ */
    .quiz-item-card { background: #fdfaf5; border: 2px dashed #eee; }
    .quiz-choice-btn { background: white; border: 2px solid #eee; border-radius: 14px; padding: 15px; text-align: left; font-size: 0.95rem; font-weight: 700; transition: 0.2s; color: #555; }
    .quiz-choice-btn:hover { border-color: var(--primary-color); background: #f0f7f5; }
    .quiz-choice-btn.is-correct { background-color: #2ecc71 !important; color: white !important; border-color: #2ecc71 !important; }
    .quiz-choice-btn.is-wrong { background-color: #e86a6a !important; color: white !important; border-color: #e86a6a !important; }

    /* 前後ボタン */
    .nav-step-btn {
        display: flex; align-items: center; padding: 12px 20px; background: white; border: 1px solid #eee; border-radius: 20px;
        text-decoration: none; color: #444; transition: 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.02);
    }
    .nav-step-btn:hover { border-color: var(--primary-color); color: var(--primary-color); transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.05); }
    .nav-step-btn.next { justify-content: flex-end; }
    .nav-step-btn .material-icons { color: var(--primary-color); }

    .admin-card { border-radius: 32px !important; }

    @media (max-width: 768px) {
        .admin-card { border-radius: 20px !important; padding: 20px !important; }
        .video-aspect-container { border-radius: 0; margin-left: -20px; margin-right: -20px; width: calc(100% + 40px); }
    }
</style>

<script>
const video = document.getElementById('trainingVideo');
const moduleId = "{{ module.id }}";
const progressText = document.getElementById('progressText');

function checkAnswer(btn, isCorrect) {
    const parent = btn.closest('.quiz-item-card');
    const explanation = parent.querySelector('.explanation-box');
    const resLabel = parent.querySelector('.res-label');
    const allBtns = parent.querySelectorAll('.quiz-choice-btn');
    allBtns.forEach(b => b.classList.remove('is-correct', 'is-wrong'));

    if (isCorrect) {
        btn.classList.add('is-correct');
        resLabel.innerHTML = '<span class="text-success fw-bold">✨ 正解です！</span>';
    } else {
        btn.classList.add('is-wrong');
        resLabel.innerHTML = '<span class="text-danger fw-bold">❌ 違います</span>';
    }
    explanation.classList.remove('d-none');
}

if (video) {
    video.addEventListener('loadedmetadata', () => {
        const lastPos = parseFloat("{{ last_position|default:0 }}");
        if (lastPos > 0) video.currentTime = lastPos;
    });
    video.addEventListener('timeupdate', () => {
        const percent = Math.floor((video.currentTime / video.duration) * 100);
        progressText.innerText = `${percent}%`;
    });
    video.onended = () => {
        saveProgress(video.currentTime, true);
        progressText.innerText = "100%";
        progressText.className = "fw-800 text-success fs-5";
    };
}

function saveProgress(position, isDone = false) {
    return fetch("{% url 'courses:save_progress' %}", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
        body: JSON.stringify({ module_id: moduleId, position: position, is_done: isDone })
    });
}

function saveAndExit() {
    const btn = document.getElementById('saveExitBtn');
    btn.disabled = true;
    const currentPos = video ? video.currentTime : 0;
    saveProgress(currentPos, false).then(() => {
        window.location.href = "{% url 'courses:staff_course_list' %}";
    });
}
</script>
{% endblock %}