{% extends base_template %}
{% load static %}
{% block breadcrumb %}<li class="breadcrumb-item active">コース・研修管理</li>{% endblock %}

{% block content %}
<div class="user-management-container pb-5">
    <!-- タイトルエリア -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="page-title text-dark m-0 fw-bold">
            コース・研修管理
        </h1>
        <div class="display-toggle">
            {% if is_trash_mode %}
            <a href="{% url 'courses:courses_list' %}" class="btn btn-outline-secondary btn-sm rounded-pill px-3 shadow-sm bg-white">通常一覧に戻る</a>
            {% else %}
            <a href="?show=deleted" class="btn btn-outline-dark btn-sm rounded-pill px-3 shadow-sm bg-white">
                <span class="material-icons fw-bold small align-middle">visibility_off</span> 削除済みを表示
            </a>
            {% endif %}
        </div>
    </div>

    <!-- コントロールパネル -->
    <div class="row g-3 mb-4 align-items-center">
        <div class="col-xl-12">
            <form method="get" action="{% url 'courses:courses_list' %}" id="filter-form" class="d-flex gap-2 align-items-center flex-wrap">
                <!-- 検索 -->
                <div class="search-input-group shadow-sm bg-white border" style="width: 280px;">
                    <span class="material-icons text-muted">search</span>
                    <input type="text" name="q" placeholder="コース名で検索..." value="{{ search_query }}" />
                </div>

                <!-- 並べ替え -->
                <select name="sort" class="form-select border shadow-sm rounded-pill px-3" style="width: 130px;" onchange="this.form.submit()">
                    <option value="newest" {% if current_sort == 'newest' %}selected{% endif %}>新しい順</option>
                    <option value="oldest" {% if current_sort == 'oldest' %}selected{% endif %}>古い順</option>
                    <option value="title" {% if current_sort == 'title' %}selected{% endif %}>名前順</option>
                </select>

                {% if not is_trash_mode %}
                <!-- 公開状態フィルタ -->
                <div class="segment-filter shadow-sm bg-white border p-1 d-flex">
                    <input type="radio" name="status" value="all" id="status-all" class="d-none" onchange="this.form.submit()" {% if current_status == 'all' %}checked{% endif %}>
                    <label for="status-all" class="segment-item">全て</label>
                    <input type="radio" name="status" value="public" id="status-public" class="d-none" onchange="this.form.submit()" {% if current_status == 'public' %}checked{% endif %}>
                    <label for="status-public" class="segment-item segment-public">公開中</label>
                    <input type="radio" name="status" value="private" id="status-private" class="d-none" onchange="this.form.submit()" {% if current_status == 'private' %}checked{% endif %}>
                    <label for="status-private" class="segment-item segment-private">非公開</label>
                </div>
                {% endif %}
                
                {% if is_trash_mode %}<input type="hidden" name="show" value="deleted" />{% endif %}

                <!-- 右寄せ -->
                <div class="ms-auto d-flex align-items-center">
                    {% if not is_trash_mode %}
                    <a href="{% url 'courses:courses_add' %}" class="btn btn-primary shadow-sm rounded-pill px-4 fw-bold d-flex align-items-center">
                        <span class="material-icons me-1">add</span> 新規作成
                    </a>
                    {% endif %}
                    <a href="javascript:void(0)" class="text-muted small text-decoration-none ms-3 d-inline-flex align-items-center help-trigger" data-bs-toggle="modal" data-bs-target="#helpModal">
                    <span class="material-icons size-18 me-1">help_outline</span> ヘルプ
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- リストエリア（アコーディオン） -->
    <form action="{% url 'courses:bulk_action_course' %}" method="post" id="course-bulk-form">
        {% csrf_token %}
        <input type="hidden" name="action" id="bulk-action-input" value="">

        <div class="course-grid">
            {% for course in courses %}
            <div class="exam-list-item user-row {% if not course.is_active and not is_trash_mode %}inactive-item{% endif %} mb-3" data-id="{{ course.id }}" id="course-{{ course.id }}">
                <div class="admin-card border-0 shadow-sm rounded-4 p-0 bg-white overflow-visible exam-card-accent accent-course position-relative">
                    
                    <!-- コースヘッダー -->
                    <div class="p-3 d-flex align-items-center card-main-row">
                        <div class="pe-3 ps-2" style="z-index: 2;">
                            <input type="checkbox" name="course_ids" value="{{ course.id }}" class="form-check-input row-checkbox" />
                        </div>

                        <!-- 追加：コース画像エリア（サムネイル表示） -->
                        <div class="course-thumb-container me-3 d-none d-md-block">
                            {% if course.thumbnail %}
                                <img src="{{ course.thumbnail.url }}" class="img-fluid rounded-3" style="width: 100%; height: 100%; object-fit: cover;">
                            {% else %}
                                <span class="material-icons text-white">auto_stories</span>
                            {% endif %}
                        </div>

                        <!-- クリックで展開するエリア -->
                        <div class="flex-grow-1" data-bs-toggle="collapse" data-bs-target="#collapse{{ course.id }}" style="cursor: pointer;">
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <span class="badge-cute badge-orange">コース</span>
                                <span class="badge-cute badge-status-active {% if not course.is_active %}d-none{% endif %}">公開中</span>
                                <span class="badge-cute badge-status-inactive {% if course.is_active %}d-none{% endif %}">非公開</span>
                                <span class="text-muted extra-small ms-1">ID: #{{ course.id }}</span>
                            </div>
                            <h3 class="h6 fw-bold text-dark mb-1">{{ course.subject }}</h3>
                            <div class="extra-small text-muted d-flex gap-3">
                                <span><i class="bi bi-collection me-1"></i>研修 {{ course.modules.count }}件</span>
                                <span><i class="bi bi-clock me-1"></i>最終更新: {{ course.updated_at|date:"Y/m/d"|default:"2026/01/26" }}</span>
                            </div>
                        </div>

                        <!-- 操作トグルとメニュー -->
                        <div class="d-flex align-items-center gap-3 pe-2">
                            {% if not is_trash_mode %}
                            <div class="toggle-center-container">
                                <div class="form-check form-switch custom-switch-cute">
                                    <input class="form-check-input toggle-active-switch" type="checkbox" 
                                           data-url="{% url 'courses:course_toggle_active' course.id %}"
                                           {% if course.is_active %}checked{% endif %}>
                                    <label class="status-label fw-bold {% if course.is_active %}text-success{% else %}text-muted{% endif %}">
                                        {% if course.is_active %}公開中{% else %}非公開{% endif %}
                                    </label>
                                </div>
                            </div>
                            {% endif %}
                            <div class="dropdown">
                                <button class="btn btn-light rounded-circle p-2 border shadow-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-boundary="viewport">
                                    <span class="material-icons">more_vert</span>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end shadow border-0 rounded-4">
                                    {% if not is_trash_mode %}
                                    <li><a class="dropdown-item py-2" href="{% url 'courses:courses_edit' course.id %}"><span class="material-icons size-18 me-2">edit</span>コース編集</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><button type="button" class="dropdown-item py-2 text-danger fw-bold action-trigger" data-action="delete" data-id="{{ course.id }}" data-msg="削除しています..."><span class="material-icons size-18 me-2">delete_outline</span>コース削除</button></li>
                                    {% else %}
                                    <li><button type="button" class="dropdown-item py-2 text-success fw-bold action-trigger" data-action="restore" data-id="{{ course.id }}" data-msg="復元しています..."><span class="material-icons size-18 me-2">history</span>コースを復元</button></li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 展開される研修リスト -->
                    <div class="collapse" id="collapse{{ course.id }}">
                        <div class="p-3 bg-light-soft border-top border-dashed rounded-bottom-4">
                            <div class="small fw-bold text-muted mb-2 px-2 d-flex align-items-center">
                                <span class="material-icons size-18 me-1">subtitles</span>研修モジュール一覧
                            </div>
                            {% for module in course.modules.all %}
                            <div class="module-item-cute d-flex align-items-center justify-content-between p-2 mb-2 bg-white rounded-3 border shadow-sm mx-2">
                                <div class="d-flex align-items-center">
                                    <span class="material-icons text-indigo me-3">play_circle_filled</span>
                                    <div>
                                        <div class="fw-bold small">{{ module.title }}</div>
                                        <div class="extra-small text-muted">{{ module.estimated_time }}分 / 例題 {{ module.examples.count }}問</div>
                                    </div>
                                </div>
                                <div class="d-flex gap-1 pe-2">
                                    {% if not is_trash_mode %}
                                    <a href="{% url 'courses:module_edit' module.id %}" class="btn btn-sm btn-light border rounded-pill px-3 extra-small fw-bold">編集</a>
                                    {% elif not module.is_active %}
                                    <button type="button" class="btn btn-sm btn-success rounded-pill px-3 extra-small fw-bold action-trigger" data-action="restore_module" data-url="{% url 'courses:module_restore' module.id %}" data-msg="研修を復元しています...">復元</button>
                                    {% endif %}
                                </div>
                            </div>
                            {% empty %}
                            <p class="text-center text-muted small py-3 mb-0">研修が登録されていません</p>
                            {% endfor %}

                            <!-- 追加：研修一覧の最下部に設置する追加ボタン -->
                            {% if not is_trash_mode %}
                            <div class="mt-3 px-2">
                                <a href="{% url 'courses:module_add' course.id %}" class="btn btn-outline-primary btn-sm w-100 rounded-3 py-2 border-dashed fw-bold d-flex align-items-center justify-content-center bg-white shadow-sm hover-up">
                                    <span class="material-icons size-18 me-1">add_circle_outline</span>
                                    このコースに研修を追加する
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="admin-card border-0 shadow-sm rounded-4 py-5 text-center text-muted bg-white">
                <div class="mb-3">
                    <span class="material-icons" style="font-size: 48px; opacity: 0.3;">search_off</span>
                </div>
                <p class="mb-1 fw-bold">該当するコースが見つかりません</p>
                <p class="small mb-0">条件を変えて再度お試しください</p>
            </div>
            {% endfor %}
        </div>

        <!-- アクションバー -->
        <div class="action-bar-container" id="floating-action-bar">
            <div class="action-bar-inner shadow-lg mx-3 mb-3 rounded-pill border-0 bg-dark text-white">
                <div class="container-fluid px-4 py-2">
                    <div class="row align-items-center">
                        <div class="col-md-auto">
                            <div class="selection-count py-1 d-flex align-items-center">
                                <span class="material-icons text-primary me-2">how_to_reg</span>
                                <span id="selected-count-display" class="fw-bold fs-5 me-2 text-primary">0</span> 件を選択中
                            </div>
                        </div>
                        <div class="col text-end">
                            <div class="d-flex gap-2 justify-content-end">
                                {% if is_trash_mode %}
                                <button type="button" class="btn btn-warning btn-sm rounded-pill px-4 fw-bold action-trigger" data-action="restore" data-msg="一括復元しています...">一括復元</button>
                                {% else %}
                                <button type="button" class="btn btn-outline-light btn-sm rounded-pill px-3 fw-bold action-trigger" data-action="make_public" data-msg="一括公開しています...">一括公開</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm rounded-pill px-3 fw-bold action-trigger" data-action="make_private" data-msg="一括非公開しています...">一括非公開</button>
                                <button type="button" class="btn btn-danger btn-sm rounded-pill px-4 fw-bold action-trigger" data-action="delete" data-msg="一括削除しています...">一括削除</button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- ページネーション（一部改修） -->
{% if is_paginated %}
<nav class="mt-5">
    <ul class="pagination justify-content-center align-items-center gap-2">
        {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link pagination-circle shadow-sm" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if is_trash_mode %}&show=deleted{% endif %}"><span class="material-icons">chevron_left</span></a></li>
        {% endif %}
        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-item active"><span class="page-link pagination-circle shadow-sm fw-bold">{{ num }}</span></li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <li class="page-item"><a class="page-link pagination-circle shadow-sm text-dark" href="?page={{ num }}{% if search_query %}&q={{ search_query }}{% endif %}{% if is_trash_mode %}&show=deleted{% endif %}">{{ num }}</a></li>
            {% endif %}
        {% endfor %}
        {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link pagination-circle shadow-sm" href="?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if is_trash_mode %}&show=deleted{% endif %}"><span class="material-icons">chevron_right</span></a></li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- ヘルプモーダル（コース・研修版） -->
<div class="modal fade" id="helpModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-5 overflow-hidden">
      <div class="modal-header bg-dark text-white border-0 py-3">
        <h5 class="modal-title fw-bold d-flex align-items-center">
          <span class="material-icons me-2">help_outline</span>
          コース・研修の操作方法
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body px-4 py-3">
        <section class="mb-3">
          <h6 class="fw-bold text-primary d-flex align-items-center mb-2">
            <span class="material-icons me-2">unfold_more</span>
            研修内容を表示する場合
          </h6>
          <p class="small text-muted ps-3 mb-0">
            コースの<b>タイトル行をクリック</b>すると、そのコースに紐づく研修（モジュール）の一覧が展開されます。
          </p>
        </section>
        <hr class="my-3">
        <section class="mb-3">
          <h6 class="fw-bold text-danger d-flex align-items-center mb-2">
            <span class="material-icons me-2">check_box</span>
            一括操作（削除・復元）をする場合
          </h6>
          <p class="small text-muted ps-3 mb-2">
            一括操作を行う際は、左側の<b>チェックボックスを直接クリック</b>して選択してください。
          </p>
          <div class="alert alert-warning py-2 rounded-3 mb-0" style="font-size: 0.75rem;">
            <i class="bi bi-info-circle me-1"></i> <b>重要</b>：行全体をクリックすると、研修内容の表示が切り替わるため、選択状態にはなりません。
          </div>
        </section>
        <hr class="my-3">
        <section>
          <h6 class="fw-bold text-success d-flex align-items-center mb-2">
            <span class="material-icons me-2">visibility</span>
            公開・非公開の切り替え
          </h6>
          <p class="small text-muted ps-3 mb-0">
            右側のスイッチを切り替えると、即座に受講者画面への表示・非表示が反映されます。メンテナンス時などにご活用ください。
          </p>
        </section>
      </div>
      <div class="modal-footer border-0 pt-0 px-3 pb-3">
        <button type="button" class="btn btn-light rounded-pill px-4 shadow-sm fw-bold w-100" data-bs-dismiss="modal">閉じる</button>
      </div>
    </div>
  </div>
</div>

<!-- 確認用ポップアップモーダル (デザイン維持) -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-5">
            <div class="modal-header border-0 pt-4 px-4">
                <h5 class="modal-title fw-800" id="confirmTitle">確認</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body px-4" id="confirmBody"></div>
            <div class="modal-footer border-0 pb-4 px-4">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-danger rounded-pill px-4 fw-bold" id="confirm-execute-btn">実行する</button>
            </div>
        </div>
    </div>
</div>

<!-- 処理中/完了ポップアップモーダル -->
<div class="modal fade" id="statusModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-5">
            <div class="modal-body text-center p-5">
                <div id="modal-loading">
                    <div class="custom-loader mb-4"></div>
                    <h5 class="fw-800 text-primary" id="loading-text">処理しています...</h5>
                    <p class="text-muted small mb-0">そのまま少々お待ちください</p>
                </div>
                <div id="modal-success" style="display: none;">
                    <div class="success-icon-wrapper mb-4">
                        <span class="material-icons text-success" style="font-size: 80px;">check_circle</span>
                    </div>
                    <h5 class="fw-800 text-dark">完了しました！</h5>
                    <p class="text-muted small mb-0">最新の情報を取得しています...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .fw-bold { font-weight: 700; }
    .extra-small { font-size: 0.72rem; }
    .size-18 { font-size: 18px; }
    .bg-light-soft { background-color: #f9fbfd; }
    .text-indigo { color: #6610f2; }

    /* カードアクセント・重なり防止 */
    .exam-list-item { position: relative; transition: 0.2s; }
    .exam-list-item:hover, .exam-list-item:focus-within, .exam-list-item:has(.show) { z-index: 10 !important; }
    .admin-card { overflow: visible !important; }
    .exam-card-accent::before {
        content: ""; position: absolute; top: 0; left: 0; bottom: 0; width: 10px;
        border-top-left-radius: inherit; border-bottom-left-radius: inherit;
        background-color: #fd7e14;
    }

    /* コース画像エリア */
    .course-thumb-container {
        width: 48px; height: 48px; background: #76b19d; border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 10px rgba(118, 177, 157, 0.2); overflow: hidden;
    }

    .badge-orange { background-color: #fff4e6; color: #fd7e14; }
    .badge-cute { font-size: 0.7rem; padding: 3px 10px; border-radius: 6px; font-weight: bold; }
    .badge-status-active { background: #e8fcf1; color: #2ecc71; border: 1px solid #d4f7e4; }
    .badge-status-inactive { background: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6; }

    .segment-filter { border-radius: 50px; }
    .segment-item { padding: 6px 18px; border-radius: 50px; cursor: pointer; font-size: 0.85rem; font-weight: bold; transition: 0.2s; margin: 0 2px; }
    #status-all:checked + label { background: #555; color: white; }
    #status-public:checked + label { background: #2ecc71; color: white; }
    #status-private:checked + label { background: #6c757d; color: white; }

    /* トグルスイッチ */
    .toggle-center-container { display: flex; justify-content: center; align-items: center; min-width: 60px; }
    .custom-switch-cute { display: flex !important; flex-direction: column !important; align-items: center !important; }
    .custom-switch-cute .form-check-input {
        width: 3rem !important; height: 1.5rem !important; margin: 0 0 4px 0 !important; cursor: pointer; float: none !important; border-radius: 2rem !important;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='white'/%3e%3c/svg%3e") !important;
        background-color: #ced4da; border-color: #ced4da; opacity: 1 !important;
    }
    .custom-switch-cute .form-check-input:checked { background-color: #76b19d !important; border-color: #76b19d !important; }
    .status-label { font-size: 0.75rem; margin: 0 !important; white-space: nowrap; line-height: 1; }

    /* 研修追加ボタンの点線デザイン */
    
    .btn-outline-primary.border-dashed:hover {
        background-color: rgba(118, 177, 157, 0.05);
        color: #76b19d;
        border-color: #76b19d !important;
    }

    .hover-up {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .hover-up:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08) !important;
    }

    /* アクションバー */
  .action-bar-container { position: fixed; bottom: 0; left: 260px; width: calc(100% - 260px); z-index: 1000; transition: 0.4s; transform: translateY(100px); opacity: 0; pointer-events: none; }
  .action-bar-container.active { transform: translateY(0); opacity: 1; pointer-events: auto; }
  .sidebar-collapsed .action-bar-container { left: 88px; width: calc(100% - 88px); }

/* サイドバーが閉じている時（bodyにクラスが付与される想定） */
body.sb-sidenav-toggled .action-bar-container {left: 0 !important; width: 100% !important;}
    .action-bar-container.active { transform: translateY(0); opacity: 1; pointer-events: auto; }

    .pagination-circle { width: 40px; height: 40px; border-radius: 50% !important; display: flex; align-items: center; justify-content: center; border: none; color: #2d3436; transition: 0.3s; background: #fff; padding: 0; }
    .page-item.active .pagination-circle { background-color: #76b19d !important; color: #fff !important; }

    /* ローディング画面 */
    .custom-loader { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; display: inline-block; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .inactive-item { filter: opacity(0.8); }
    .search-input-group { border-radius: 50px; padding: 6px 15px; display: flex; align-items: center; border: 1px solid rgba(0,0,0,0.1); background: white;}
    .search-input-group input { border: none; outline: none; background: transparent; margin-left: 8px; width: 100%; }

    /* ヘルプボタンのスタイル */
  .help-trigger {
    transition: 0.2s;
    opacity: 0.7;
  }
  .help-trigger:hover {
    opacity: 1;
    color: var(--primary-color) !important;
  }

    @media (max-width: 991px) { .action-bar-container { left: 0; width: 100%; } }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const actionBar = document.getElementById('floating-action-bar');
    const countDisplay = document.getElementById('selected-count-display');
    const statusModal = new bootstrap.Modal(document.getElementById('statusModal'));
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    const bulkForm = document.getElementById('course-bulk-form');
    const actionInput = document.getElementById('bulk-action-input');
    const confirmExecuteBtn = document.getElementById('confirm-execute-btn');

    // 実行待ちの状態を保持する変数
    let pendingAction = '';
    let pendingMsg = '';

    function updateSelection() {
        const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
        if (countDisplay) countDisplay.innerText = checkedCount;
        if (actionBar) {
            if (checkedCount > 0) actionBar.classList.add('active');
            else actionBar.classList.remove('active');
        }
    }

    // チェックボックス直接クリック時のみ選択
    document.querySelectorAll('.row-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
            this.closest('.admin-card').classList.toggle('table-selected', this.checked);
            updateSelection();
        });
    });

    // リアルタイムトグル（Ajax）
    document.querySelectorAll('.toggle-active-switch').forEach(sw => {
        sw.addEventListener('change', function() {
            const url = this.dataset.url;
            
            const card = this.closest('.exam-list-item');
            const label = this.closest('.custom-switch-cute').querySelector('.status-label');
            const activeBadge = card.querySelector('.badge-status-active');
            const inactiveBadge = card.querySelector('.badge-status-inactive');
            
            const isActive = this.checked;
            label.innerText = isActive ? "公開中" : "非公開";
            label.className = `status-label fw-bold ${isActive ? 'text-success' : 'text-muted'}`;
            card.classList.toggle('inactive-item', !isActive);
            
            if (isActive) {
                activeBadge.classList.remove('d-none');
                inactiveBadge.classList.add('d-none');
            } else {
                activeBadge.classList.add('d-none');
                inactiveBadge.classList.remove('d-none');
            }

            fetch(url, {
                method: 'POST',
                headers: { 
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json' 
                }
            })
            .then(response => {
                if (!response.ok) {
                    alert('保存に失敗しました。');
                    this.checked = !isActive;
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    });

    // アクション実行ボタン（一括削除・復元・公開・非公開など）
    document.querySelectorAll('.action-trigger').forEach(btn => {
        btn.addEventListener('click', function() {
            pendingAction = this.dataset.action;
            pendingMsg = this.dataset.msg;
            const id = this.dataset.id;

            // 個別操作の場合は、そのIDのチェックボックスだけを選択状態にする
            if (id) {
                document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = false);
                const targetCb = document.querySelector(`.row-checkbox[value="${id}"]`);
                if (targetCb) targetCb.checked = true;
            }
            
            // 確認モーダルのテキストを設定
            if (pendingAction === 'delete') {
                document.getElementById('confirmTitle').innerText = '削除の確認';
                document.getElementById('confirmBody').innerHTML = `
                    <p class="mb-0 fw-bold">選択した項目をゴミ箱へ移動しますか？</p>
                `;
                // 確認モーダルを表示（実行はconfirmExecuteBtnのイベントで）
                confirmModal.show();
            } else {
                // 削除以外（公開・非公開・復元）は確認なしで即ローディングへ
                executeFinalAction(pendingAction, pendingMsg);
            }
        });
    });

    // 確認モーダルの中の「実行する」ボタンを押した時
    confirmExecuteBtn.addEventListener('click', function() {
        confirmModal.hide();
        executeFinalAction(pendingAction, pendingMsg || (pendingAction === 'delete' ? '削除しています...' : '処理しています...'));
    });

    // 共通実行処理（ローディング表示 → 送信）
    function executeFinalAction(action, msg) {
        document.getElementById('loading-text').innerText = msg || '処理しています...';
        actionInput.value = action;
        
        statusModal.show();

        setTimeout(() => {
            document.getElementById('modal-loading').style.display = 'none';
            document.getElementById('modal-success').style.display = 'block';
            setTimeout(() => { 
                bulkForm.submit(); 
            }, 800);
        }, 1200);
    }
});
</script>
{% endblock %}