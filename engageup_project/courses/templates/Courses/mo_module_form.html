{% extends base_template %}
{% load static %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'courses:courses_list' %}" class="text-decoration-none">コース・研修管理</a></li>
<li class="breadcrumb-item active">{% if object %}研修編集{% else %}新規研修追加{% endif %}</li>
{% endblock %}

{% block content %}
<div class="container-fluid pb-5">
    <!-- ヘッダーエリア -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h2 class="fw-800 text-dark m-0">
                    {% if object %}研修編集{% else %}新規研修追加{% endif %}
                </h2>
            </div>
            <a href="{% url 'courses:courses_list' %}" class="btn btn-outline-secondary btn-rounded-cute px-3 bg-white shadow-sm">
                <span class="material-icons size-18 align-middle">arrow_back</span> 戻る
            </a>
        </div>
    </div>

    <!-- メイン保存フォーム -->
    <form method="post" enctype="multipart/form-data" id="mainTrainingForm" novalidate>
        {% csrf_token %}
        
        <!-- 上段：2カラムエリア（①基本情報 ＆ ②設定・AI） -->
        <div class="row g-4 d-flex align-items-stretch mb-4">
            <!-- 左カラム：研修の基本構成 (①) -->
            <div class="col-lg-7">
                <div class="admin-card border-0 shadow-sm rounded-5 bg-white p-4 p-md-5 h-100 position-relative">
                    <div class="d-flex align-items-center mb-4">
                        <span class="step-badge me-2">1</span>
                        <h5 class="fw-800 m-0">基本情報</h5>
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-bold text-dark d-flex align-items-center">
                            研修タイトル <span class="badge-required ms-2">必須</span>
                        </label>
                        {{ form.title }}
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-5">
                            <label class="form-label fw-bold text-dark">推奨学習時間 (分)</label>
                            {{ form.estimated_time }}
                            <div class="form-text-ultra-light mt-2">例：15</div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold text-dark">研修テキスト（内容の要約）</label>
                        <div class="textarea-container">
                            {{ form.content_text }}
                        </div>
                        <div class="form-text-ultra-light mt-2">AIで生成した内容がここに入ります。</div>
                    </div>
                    <div class="mb-0">
                        <label class="form-label fw-bold text-dark">研修動画ファイル</label>
                        <div class="video-input-card p-3 p-md-4 rounded-4 bg-light-soft border border-dashed">
                            {{ form.video }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右カラム：教材設定 ＆ AIアシスタント (②) -->
            <div class="col-lg-5 d-flex flex-column gap-4">
                <div class="admin-card border-0 shadow-sm rounded-5 bg-white p-4 p-md-5">
                    <div class="d-flex align-items-center mb-4">
                        <span class="step-badge me-2">2</span>
                        <h5 class="fw-800 m-0">教材資料の設定</h5>
                    </div>
                    <div class="resource-card rounded-4 p-3 p-md-4">
                        <div class="d-flex flex-column gap-3">
                            <div id="upload-group" class="option-box-vertical p-3 rounded-4 bg-white border">
                                <label class="small fw-800 text-primary d-flex align-items-center mb-2">
                                    <span class="material-icons size-18 me-1">upload</span> 1. 新しくアップロード
                                </label>
                                {{ form.training_file }}
                            </div>
                            <div class="or-divider-horizontal">
                                <span class="or-text shadow-sm">OR</span>
                            </div>
                            <div id="select-group" class="option-box-vertical p-3 rounded-4 bg-white border">
                                <label class="small fw-800 text-success d-flex align-items-center mb-2">
                                    <span class="material-icons size-18 me-1">folder_shared</span> 2. 過去から選ぶ
                                </label>
                                {{ form.existing_file }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="ai-feature-card shadow-lg rounded-5 p-4 p-md-5 position-relative overflow-hidden flex-grow-1">
                    <span class="material-icons position-absolute ai-bg-icon">auto_awesome</span>
                    <div class="d-flex align-items-center mb-3 position-relative" style="z-index: 2;">
                        <div class="ai-icon-circle me-3">
                            <span class="material-icons text-white size-28">psychology</span>
                        </div>
                        <div>
                            <h5 class="fw-800 m-0 text-white">AIおまかせ作成アシスト</h5>
                            <p class="text-white opacity-75 small mb-0">教材を解析して自動生成します</p>
                        </div>
                    </div>
                    <div class="position-relative d-flex flex-column h-100" style="z-index: 2;">
                        {% if object %}
                        <div class="bg-white bg-opacity-10 rounded-4 p-3 mt-3 border border-white border-opacity-10">
                            <div class="mb-4">
                                <label class="small fw-800 text-white mb-2">AIへのこだわり指示（任意）</label>
                                <textarea id="ai-instruction-input" class="form-control-ai" rows="2" placeholder="例：専門用語を分かりやすく解説してください。"></textarea>
                            </div>
                            <button type="button" id="ai-generate-btn-trigger" class="btn btn-white-magic w-100 py-3 fw-800 shadow" {% if not object.training_file %}disabled{% endif %}>
                                <span class="material-icons align-middle me-2">flare</span> AIにおまかせで作成する
                            </button>
                        </div>
                        {% else %}
                        <div class="text-center py-4 flex-grow-1 d-flex flex-column justify-content-center">
                            <p class="text-white small mb-4 opacity-90">保存後にAI機能が使えます</p>
                            <button type="submit" name="after_save" value="ai" class="btn btn-white-magic px-5 py-3 fw-800 shadow mx-auto">保存してAIを起動</button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 下段：横幅いっぱいエリア (③ 例題プレビュー) -->
        <div class="row">
            <div class="col-12">
                <div class="admin-card border-0 shadow-sm rounded-5 bg-white p-4 p-md-5 mb-4 position-relative">
                    <div class="d-flex align-items-center mb-4">
                        <span class="step-badge me-2">3</span>
                        <h5 class="fw-800 m-0">例題プレビュー</h5>
                    </div>

                    {% if object and object.examples.all %}
                    <div class="mb-2">
                        <label class="form-label fw-bold text-dark d-flex align-items-center mb-3">
                            <span class="material-icons text-primary me-2">quiz</span>
                            AI作成済みの例題（復習用）
                        </label>
                        
                        <div class="row g-4">
                            {% for example in object.examples.all %}
                            <div class="col-md-6"> <!-- 2つの例題が横に並ぶ -->
                                <div class="p-4 rounded-4 border bg-light-soft h-100 shadow-sm">
                                    <div class="d-flex align-items-start gap-2 mb-3">
                                        <span class="badge bg-primary rounded-pill extra-small px-2">例題 {{ forloop.counter }}</span>
                                        <div class="fw-bold text-dark line-height-base">{{ example.text }}</div>
                                    </div>
                                    
                                    <div class="row g-2 ms-1 mb-3">
                                        {% for choice in example.choices.all %}
                                        <div class="col-sm-6">
                                            <div class="extra-small p-2 rounded-3 border d-flex align-items-center gap-2 {% if choice.is_correct %}bg-success-light border-success text-success fw-bold{% else %}bg-white text-muted border-light{% endif %}">
                                                <span class="material-icons size-16">
                                                    {% if choice.is_correct %}check_circle{% else %}radio_button_unchecked{% endif %}
                                                </span>
                                                {{ choice.text }}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>

                                    {% if example.explanation %}
                                    <div class="p-3 rounded-3 bg-white border-start border-4 border-primary">
                                        <div class="extra-small text-muted"><span class="fw-bold text-primary">解説：</span>{{ example.explanation }}</div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-5 text-muted opacity-50">
                        <span class="material-icons size-48">pending_actions</span>
                        <p class="mt-2">AIアシストを実行すると、ここに例題のプレビューが表示されます</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 最下部：保存ボタン -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <button type="submit" class="btn btn-primary btn-rounded-cute px-5 py-3 fw-800 shadow-lg mb-3" style="min-width: 320px;">
                    研修の内容をすべて保存する <span class="material-icons align-middle ms-1">check_circle</span>
                </button>
            </div>
        </div>
    </form>

    <!-- 隠しAI送信フォーム -->
    {% if object %}
    <form action="{% url 'courses:ai_full_generate' object.id %}" method="post" id="ai-gen-form-actual" class="d-none">
        {% csrf_token %}
        <input type="hidden" name="user_instruction" id="hidden-instruction">
    </form>
    {% endif %}
</div>

<!-- 処理中モーダル -->
<div class="modal fade" id="statusModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-5 text-center p-5">
            <div class="custom-loader mb-4"></div>
            <h5 class="fw-800 text-primary" id="loading-text">処理しています...</h5>
        </div>
    </div>
</div>

<style>
    .fw-800 { font-weight: 800; }
    .extra-small { font-size: 0.72rem; }
    .size-16 { font-size: 16px; }
    .size-32 { font-size: 32px; }
    .admin-card { border-left: 10px solid #76b19d !important; border-radius: 2.5rem !important; overflow: visible !important; }
    .video-input-card { font-size: 0.82rem; color: #666; word-break: break-all; }
    .video-input-card a { color: #76b19d; text-decoration: none; font-weight: bold; display: block; margin-bottom: 8px; }
    .ai-feature-card { background: linear-gradient(135deg, #76b19d 0%, #4a8d75 100%) !important; color: white !important; border: none !important; display: flex; flex-direction: column; }
    .ai-icon-circle { width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 15px; display: flex; align-items: center; justify-content: center; }
    .ai-bg-icon { font-size: 240px; color: rgba(255,255,255,0.08); right: -40px; bottom: -60px; transform: rotate(-15deg); pointer-events: none; }
    .form-control-ai { width: 100%; padding: 12px; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 12px; background: rgba(255,255,255,0.1) !important; color: white !important; }
    .btn-white-magic { background-color: white !important; color: #4a8d75 !important; border: none !important; border-radius: 15px; transition: 0.3s; }
    .bg-success-light { background-color: #e8f5e9; }
    .bg-light-soft { background-color: #f8faf9; }
    .step-badge { width: 32px; height: 32px; background-color: #76b19d; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; }
    .badge-required { background-color: #ff7675; color: white; font-size: 0.62rem; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
    input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 14px 18px; border: 2px solid #f2f2f2; border-radius: 16px; background-color: #fdfdfd; transition: 0.3s; font-size: 0.95rem; }
    textarea { height: 180px; }
    .form-text-ultra-light { color: #d1d1d1 !important; font-size: 0.75rem; }
    .resource-card { background-color: #fcfdfe; border: 2px solid #edf2f7; }
    .or-divider-horizontal { position: relative; text-align: center; height: 1px; background: #edf2f7; margin: 15px 0; }
    .or-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 2px 12px; border: 1px solid #edf2f7; border-radius: 20px; font-size: 0.65rem; font-weight: 900; color: #a0aec0; }
    .btn-rounded-cute { border-radius: 50px; }
    .btn-primary { background-color: #76b19d; border: none; }
    .option-disabled { opacity: 0.4; filter: grayscale(1); pointer-events: none; }
    .custom-loader { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #76b19d; border-radius: 50%; display: block; margin: 0 auto; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusModal = new bootstrap.Modal(document.getElementById('statusModal'));
    const mainForm = document.getElementById('mainTrainingForm');
    const aiBtnTrigger = document.getElementById('ai-generate-btn-trigger');
    const aiFormActual = document.getElementById('ai-gen-form-actual');

    if (aiBtnTrigger) {
        aiBtnTrigger.addEventListener('click', function() {
            const instructionInput = document.getElementById('ai-instruction-input');
            const hiddenInput = document.getElementById('hidden-instruction');
            hiddenInput.value = instructionInput.value;
            document.getElementById('loading-text').innerText = "AIが研修を作成しています...";
            statusModal.show();
            setTimeout(() => aiFormActual.submit(), 300);
        });
    }

    mainForm.addEventListener('submit', function() {
        if (mainForm.checkValidity()) {
            document.getElementById('loading-text').innerText = "研修内容を保存しています...";
            statusModal.show();
        }
    });

    const uploadInput = document.querySelector('input[name="training_file"]');
    const selectBox = document.querySelector('select[name="existing_file"]');
    const uploadGroup = document.getElementById('upload-group');
    const selectGroup = document.getElementById('select-group');

    function updateFileOptions() {
        if (uploadInput && uploadInput.value) {
            selectGroup.classList.add('option-disabled');
            uploadGroup.classList.remove('option-disabled');
        } else if (selectBox && selectBox.value) {
            uploadGroup.classList.add('option-disabled');
            selectGroup.classList.remove('option-disabled');
        } else {
            if (uploadGroup) uploadGroup.classList.remove('option-disabled');
            if (selectGroup) selectGroup.classList.remove('option-disabled');
        }
    }
    if (uploadInput) uploadInput.addEventListener('change', updateFileOptions);
    if (selectBox) selectBox.addEventListener('change', updateFileOptions);
    updateFileOptions();
});
</script>
{% endblock %}